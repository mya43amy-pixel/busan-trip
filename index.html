<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Busan 2026</title>
    <meta name="apple-mobile-web-app-title" content="Busan 2026">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="icon.png?v=144">
    <link rel="icon" href="icon.png?v=144">

    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vuedraggable/4.1.0/vuedraggable.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: #f8fbfb; -webkit-tap-highlight-color: transparent; }
        .teal-theme { background-color: #78B7BB; }
        .teal-text { color: #78B7BB; }
        .active-tab { color: #78B7BB !important; font-weight: bold; }
        .input-round { border-radius: 12px; border: 1px solid #eef2f2; padding: 10px; outline: none; background: #f9fbfb; width: 100%; }
        .card-pop { border-radius: 20px; background: white; box-shadow: 0 4px 12px rgba(120, 183, 187, 0.08); }
        .card-bought { opacity: 0.6; filter: grayscale(0.5); }
        [v-cloak] { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .date-btn { min-width: 65px; height: 65px; border-radius: 20px; transition: all 0.3s; }
        .export-mode { padding: 0 !important; width: 375px !important; }
        .export-mode .fixed, .export-mode .border-dashed { display: none !important; }
        .export-mode header { border-radius: 0 !important; }
        .drag-handle { cursor: grab; padding: 4px; color: rgba(255,255,255,0.7); transition: color 0.2s; }
        .drag-handle:hover { color: white; }
        .shop-img-container { width: 100%; aspect-ratio: 1 / 1; overflow: hidden; background: #f9fbfb; display: flex; align-items: center; justify-content: center; position: relative; }
        .shop-img-container img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>
    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen pb-28 relative bg-[#f8fbfb] shadow-2xl">
        <header id="header-area" class="teal-theme pt-6 pb-4 px-4 text-white rounded-b-[35px] shadow-lg">
            <h1 class="text-center text-base font-black tracking-[0.3em] mb-4 uppercase">2026 busan</h1>
            <div class="flex justify-center items-center gap-2 overflow-x-auto no-scrollbar px-1">
                <div v-for="(d, i) in dateConfig" :key="i" @click="selectedDay = (i+1)" 
                     :class="selectedDay === (i+1) ? 'bg-white text-[#78B7BB] shadow-md' : 'bg-white/20 text-white'" 
                     class="date-btn flex flex-col items-center justify-center cursor-pointer">
                    <span class="text-[10px] opacity-70 font-bold mb-0.5">{{d.day}}</span>
                    <span class="text-lg font-black">{{d.date.split('/')[1]}}</span>
                </div>
            </div>
            <div class="export-only hidden text-center mt-4 font-black tracking-widest text-xs opacity-60">DAY {{selectedDay}} ITINERARY</div>
        </header>

        <main class="p-5">
            <div v-if="activeTab === 'itinerary'" class="space-y-6">
                <div @click="openSummaryModal" class="summary-box w-full py-4 px-6 bg-[#FEF9E7] rounded-2xl border border-[#F9E79F] text-center shadow-sm cursor-pointer">
                    <p class="text-gray-600 font-bold text-sm tracking-widest uppercase">{{ dailySummaries[selectedDay] || '點擊編輯今日大綱...' }}</p>
                </div>
                
                <div v-for="(item, index) in (itinerary[selectedDay] || [])" :key="index">
                    <div v-if="item.transitTime" class="flex items-center gap-2 ml-8 mb-2 text-[13px] text-gray-400 font-bold">
                        <i v-for="t in (item.transitType ? item.transitType.split(',') : [])" :key="t" :class="getTransitIcon(t)"></i>
                        <span>{{item.transitTime}}{{item.transitUnit}}</span>
                    </div>
                    <div @click="openEditModal(index)" class="p-5 card-pop border border-gray-50 flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2.5">
                                <span class="text-[12px] font-black px-2.5 py-1 bg-teal-50 teal-text rounded-md">{{item.time}}</span>
                                <a v-if="item.mapUrl" :href="item.mapUrl" target="_blank" @click.stop class="w-7 h-7 flex items-center justify-center bg-gray-100 rounded-full text-xs teal-text"><i class="fas fa-map-marker-alt"></i></a>
                            </div>
                            <h3 class="font-bold text-lg mt-2.5 text-gray-800">{{item.place}}</h3>
                            <p class="text-[13px] text-gray-400 mt-1.5 whitespace-pre-wrap">{{item.note}}</p>
                        </div>
                    </div>
                </div>

                <button @click="openAddModal" class="w-full py-4 border-2 border-dashed border-teal-100 rounded-[24px] text-teal-200 font-bold">+ 新增行程</button>

                <div class="mt-10 pt-10 border-t border-gray-100">
                    <div class="flex items-center justify-between mb-4 px-2">
                        <h3 class="font-black text-gray-400 text-xs tracking-widest uppercase">URL Links / Memo</h3>
                        <button @click="addNote" class="text-teal-300 text-xs font-bold">+ 新增</button>
                    </div>
                    <div class="space-y-3">
                        <div v-for="(note, idx) in travelNotes" :key="idx" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-50 flex items-center gap-3">
                            <div class="flex flex-col gap-1">
                                <button @click="moveNote(idx, -1)" class="text-[10px] text-gray-200"><i class="fas fa-chevron-up"></i></button>
                                <button @click="moveNote(idx, 1)" class="text-[10px] text-gray-200"><i class="fas fa-chevron-down"></i></button>
                            </div>
                            <div class="flex-1 overflow-hidden">
                                <input v-model="travelNotes[idx]" @change="sync" placeholder="輸入網址或備註..." class="w-full bg-transparent text-sm text-gray-600 outline-none">
                                <a v-if="travelNotes[idx] && travelNotes[idx].startsWith('http')" :href="travelNotes[idx]" target="_blank" class="text-[10px] teal-text font-bold mt-1 block">開啟網址 <i class="fas fa-external-link-alt"></i></a>
                            </div>
                            <button @click="removeNote(idx)" class="text-gray-200"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                </div>
                
                <button @click="exportImage" class="w-full mt-6 py-3 text-gray-300 text-[10px] font-black tracking-[0.2em] uppercase">Export Day {{selectedDay}} Image</button>
            </div>

            <div v-if="activeTab === 'wallet'" class="space-y-6">
                <div class="bg-gradient-to-br from-[#78B7BB] to-[#95d1d5] p-6 rounded-[30px] text-white shadow-xl text-center">
                    <p class="text-[10px] opacity-80 font-bold uppercase tracking-widest">Total Spent</p>
                    <h2 class="text-4xl font-black">₩ {{totalSpent.toLocaleString()}}</h2>
                    <p class="text-sm opacity-70 font-bold">≈ NT$ {{Math.round(totalSpent * 0.024).toLocaleString()}}</p>
                </div>
                <div class="space-y-3">
                    <div v-for="(bill, index) in bills" :key="index" @click="editBill(index)" class="bg-white p-4 rounded-2xl flex justify-between items-center border border-gray-50 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-teal-50 flex items-center justify-center teal-text"><i :class="bill.method === '現金' ? 'fas fa-coins' : 'fas fa-credit-card'"></i></div>
                            <div>
                                <p class="font-bold text-gray-800 text-sm">{{bill.itemName}}</p>
                                <p class="text-[10px] text-gray-400 font-bold">{{bill.payer}} · {{bill.category}}</p>
                                <p v-if="bill.note" class="text-[10px] text-teal-300 mt-1 italic">{{bill.note}}</p>
                            </div>
                        </div>
                        <p class="font-black text-sm text-gray-700">₩ {{bill.amount.toLocaleString()}}</p>
                    </div>
                </div>
                <button @click="openBillModal" class="fixed bottom-28 right-6 w-16 h-16 teal-theme text-white rounded-full shadow-2xl flex items-center justify-center text-2xl border-4 border-white z-50"><i class="fas fa-plus"></i></button>
            </div>

            <div v-if="activeTab === 'tools'" class="space-y-8">
                <div class="card-pop p-4 space-y-3">
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl">
                        <span class="text-xs font-bold text-gray-400 font-black">KRW</span>
                        <input type="number" v-model="convKRW" @input="updateConv('KRW')" class="text-right bg-transparent outline-none font-bold flex-1" placeholder="韓元">
                    </div>
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl">
                        <span class="text-xs font-bold text-gray-400 font-black">TWD</span>
                        <input type="number" v-model="convTWD" @input="updateConv('TWD')" class="text-right bg-transparent outline-none font-bold teal-text flex-1" placeholder="台幣">
                    </div>
                </div>
                <div v-for="cat in ['食物', '購物', '美妝', '其他']" :key="cat" class="space-y-3">
                    <h3 class="font-black text-gray-700 text-sm px-2 tracking-widest">{{cat}}</h3>
                    <draggable v-model="shoppingList" :group="{ name: 'shop', pull: false, put: false }" handle=".drag-handle" @change="sync" item-key="id" class="grid grid-cols-2 gap-3">
                        <template #item="{element}">
                            <div v-if="element.category === cat" class="card-pop overflow-hidden border border-gray-50 relative" :class="{'card-bought': element.isBought}">
                                <div @click="editShopItem(element.id)" class="shop-img-container">
                                    <img v-if="element.imgBase64" :src="element.imgBase64">
                                    <i v-else class="fas fa-shopping-bag text-gray-100 text-3xl"></i>
                                    <div class="drag-handle absolute top-2 left-2 bg-black/20 rounded-lg p-1">
                                        <i class="fas fa-grip-vertical text-white text-[10px]"></i>
                                    </div>
                                </div>
                                <div class="p-3">
                                    <h4 class="font-bold text-gray-800 text-xs truncate">{{element.name}}</h4>
                                    <p class="teal-text font-black text-xs">₩ {{element.price.toLocaleString()}}</p>
                                </div>
                                <button @click.stop="toggleBought(element.id)" class="absolute top-2 right-2 w-7 h-7 rounded-full flex items-center justify-center shadow-md bg-white/80" :class="element.isBought ? 'teal-theme text-white' : 'text-gray-300'"><i class="fas fa-check text-[10px]"></i></button>
                            </div>
                        </template>
                    </draggable>
                </div>
                <button @click="openShopModal" class="w-full py-4 border-2 border-dashed border-teal-100 rounded-[24px] text-teal-200 font-bold">+ 新增待買</button>
            </div>
        </main>

        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/95 border-t border-gray-100 flex justify-around py-5 rounded-t-[35px] z-40">
            <button @click="activeTab = 'itinerary'" :class="{'active-tab': activeTab === 'itinerary'}" class="flex flex-col items-center text-gray-300"><i class="fas fa-calendar-alt text-xl"></i><span class="text-[9px] mt-1 font-black">PLAN</span></button>
            <button @click="activeTab = 'wallet'" :class="{'active-tab': activeTab === 'wallet'}" class="flex flex-col items-center text-gray-300"><i class="fas fa-wallet text-xl"></i><span class="text-[9px] mt-1 font-black">WALLET</span></button>
            <button @click="activeTab = 'tools'" :class="{'active-tab': activeTab === 'tools'}" class="flex flex-col items-center text-gray-300"><i class="fas fa-shopping-bag text-xl"></i><span class="text-[9px] mt-1 font-black">SHOP</span></button>
        </nav>

        <div v-if="showModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-end">
            <div class="bg-white w-full rounded-t-[40px] p-8 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-xl font-black text-gray-800">{{isEditing ? '編輯行程' : '新增行程'}}</h3>
                    <button @click="showModal = false" class="w-10 h-10 bg-gray-50 rounded-full flex items-center justify-center text-gray-400"><i class="fas fa-times"></i></button>
                </div>
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-black text-gray-400 mb-2 uppercase tracking-widest">時間</label><input type="time" v-model="form.time" class="input-round font-bold teal-text text-lg"></div>
                        <div><label class="block text-xs font-black text-gray-400 mb-2 uppercase tracking-widest">地點</label><input v-model="form.place" class="input-round" placeholder="地點名稱"></div>
                    </div>
                    <div><label class="block text-xs font-black text-gray-400 mb-2 uppercase tracking-widest">備註</label><textarea v-model="form.note" class="input-round h-24" placeholder="備註"></textarea></div>
                    <div><label class="block text-xs font-black text-gray-400 mb-2 uppercase tracking-widest">地圖 URL</label><input v-model="form.mapUrl" class="input-round" placeholder="URL"></div>
                    <div class="bg-gray-50 p-5 rounded-[24px] space-y-4">
                        <label class="block text-xs font-black text-gray-400 uppercase tracking-widest">交通方式</label>
                        <div class="flex gap-2">
                            <button v-for="t in ['walk', 'car', 'bus', 'subway', 'plane']" :key="t" @click="toggleTransit(t)" :class="form.transitType.includes(t) ? 'teal-theme text-white' : 'bg-white text-gray-300'" class="w-10 h-10 rounded-full flex items-center justify-center shadow-sm"><i :class="getTransitIcon(t)"></i></button>
                        </div>
                        <div class="flex items-center gap-3 mt-4"><input type="number" v-model="form.transitTime" class="input-round w-24 text-center" placeholder="時間"><select v-model="form.transitUnit" class="input-round w-24"><option value="m">分鐘</option><option value="h">小時</option></select></div>
                    </div>
                    <div class="flex gap-3 pt-4"><button v-if="isEditing" @click="deleteItem" class="flex-1 py-4 bg-red-50 text-red-400 rounded-2xl font-bold">刪除</button><button @click="saveForm" class="flex-[2] py-4 teal-theme text-white rounded-2xl font-black">儲存</button></div>
                </div>
            </div>
        </div>

        <div v-if="showBillModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-end">
            <div class="bg-white w-full rounded-t-[40px] p-8 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-8"><h3 class="text-xl font-black text-gray-800">{{isEditBill ? '編輯消費' : '新增消費'}}</h3><button @click="showBillModal = false" class="text-gray-400"><i class="fas fa-times"></i></button></div>
                <div class="space-y-6">
                    <div><label class="block text-xs font-black text-gray-400 mb-2 uppercase tracking-widest">項目名稱</label><input v-model="billForm.itemName" class="input-round" placeholder="名稱"></div>
                    <div><label class="block text-xs font-black text-gray-400 mb-2 uppercase tracking-widest">金額 (KRW)</label><input type="number" v-model="billForm.amount" class="input-round" placeholder="0"></div>
                    <div><label class="block text-xs font-black text-gray-400 mb-2 uppercase tracking-widest">支付方式</label>
                        <div class="grid grid-cols-2 gap-3"><button v-for="m in ['現金', '刷卡']" :key="m" @click="billForm.method = m" :class="billForm.method === m ? 'teal-theme text-white' : 'bg-gray-50 text-gray-400'" class="py-3 rounded-xl font-bold text-sm">{{m}}</button></div>
                    </div>
                    <div><label class="block text-xs font-black text-gray-400 mb-2 uppercase tracking-widest">分類</label>
                        <div class="grid grid-cols-3 gap-2"><button v-for="c in ['食物', '購物', '美妝', '交通', '其他']" :key="c" @click="billForm.category = c" :class="billForm.category === c ? 'teal-theme text-white' : 'bg-gray-50 text-gray-400'" class="py-2.5 rounded-xl font-bold text-xs">{{c}}</button></div>
                    </div>
                    <div><label class="block text-xs font-black text-gray-400 mb-2 uppercase tracking-widest">備註</label><textarea v-model="billForm.note" class="input-round h-20" placeholder="備註"></textarea></div>
                    <div class="flex gap-3 pt-4"><button v-if="isEditBill" @click="deleteBill" class="flex-1 py-4 bg-red-50 text-red-400 rounded-2xl font-bold">刪除</button><button @click="saveBill" class="flex-[2] py-4 teal-theme text-white rounded-2xl font-black">儲存</button></div>
                </div>
            </div>
        </div>

        <div v-if="showShopModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-end">
            <div class="bg-white w-full rounded-t-[40px] p-8 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-8"><h3 class="text-xl font-black text-gray-800">{{isEditShop ? '編輯待買' : '新增待買'}}</h3><button @click="showShopModal = false" class="text-gray-400"><i class="fas fa-times"></i></button></div>
                <div class="space-y-6">
                    <div class="flex justify-center"><label class="w-32 h-32 bg-gray-50 rounded-3xl border-2 border-dashed border-gray-100 flex flex-col items-center justify-center cursor-pointer overflow-hidden relative"><img v-if="shopForm.imgBase64" :src="shopForm.imgBase64" class="w-full h-full object-cover"><div v-else class="text-center"><i class="fas fa-camera text-gray-200 mb-1"></i><p class="text-[8px] text-gray-300 font-bold">Upload</p></div><input type="file" @change="handleFileUpload" class="hidden" accept="image/*"></label></div>
                    <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-black text-gray-400 mb-2 uppercase tracking-widest">名稱</label><input v-model="shopForm.name" class="input-round"></div><div><label class="block text-xs font-black text-gray-400 mb-2 uppercase tracking-widest">金額</label><input type="number" v-model="shopForm.price" class="input-round"></div></div>
                    <div><label class="block text-xs font-black text-gray-400 mb-2 uppercase tracking-widest">分類</label><div class="grid grid-cols-4 gap-2"><button v-for="c in ['食物', '購物', '美妝', '其他']" :key="c" @click="shopForm.category = c" :class="shopForm.category === c ? 'teal-theme text-white' : 'bg-gray-50 text-gray-400'" class="py-2.5 rounded-xl font-bold text-xs">{{c}}</button></div></div>
                    <div class="flex gap-3 pt-4"><button v-if="isEditShop" @click="deleteShopItem" class="flex-1 py-4 bg-red-50 text-red-400 rounded-2xl font-bold">刪除</button><button @click="saveShopItem" class="flex-[2] py-4 teal-theme text-white rounded-2xl font-black">儲存</button></div>
                </div>
            </div>
        </div>

        <div v-if="showSummaryModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] flex items-center justify-center p-6">
            <div class="bg-white w-full rounded-[35px] p-8 shadow-2xl">
                <h3 class="text-lg font-black text-gray-800 mb-6 text-center">Edit Summary</h3>
                <input v-model="tempSummary" class="input-round text-center font-bold">
                <div class="flex gap-3 mt-8"><button @click="showSummaryModal = false" class="flex-1 py-4 bg-gray-50 text-gray-400 rounded-2xl font-bold">取消</button><button @click="saveSummary" class="flex-1 py-4 teal-theme text-white rounded-2xl font-black">儲存</button></div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const firebaseConfig = { apiKey: "AIzaSyAqfcjA5QuZlDibAJlkJL7IJvj4zwxyjPM", authDomain: "busan-trip-bibi.firebaseapp.com", databaseURL: "https://busan-trip-bibi-default-rtdb.firebaseio.com", projectId: "busan-trip-bibi", storageBucket: "busan-trip-bibi.firebasestorage.app", messagingSenderId: "396715066973", appId: "1:396715066973:web:3e839e086f68e0d47348e3" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const DATA_PATH = 'busan_trip_final';

        createApp({
            components: { draggable: vuedraggable },
            data() {
                return {
                    activeTab: 'itinerary', selectedDay: 1,
                    showModal: false, showBillModal: false, showShopModal: false, showSummaryModal: false,
                    isEditing: false, isEditBill: false, isEditShop: false, editIndex: null, tempSummary: '',
                    dateConfig: [{date: '2/17', day: '二'}, {date: '2/18', day: '三'}, {date: '2/19', day: '四'}, {date: '2/20', day: '五'}, {date: '2/21', day: '六'}],
                    form: { time: '09:00', place: '', note: '', transitType: '', transitTime: '', transitUnit: 'm', mapUrl: '' },
                    billForm: { itemName: '', amount: '', method: '現金', payer: 'Bibi', category: '食物', note: '' },
                    shopForm: { name: '', price: 0, category: '購物', imgBase64: '', isBought: false },
                    itinerary: {1:[], 2:[], 3:[], 4:[], 5:[]}, bills: [], shoppingList: [], dailySummaries: {1:'', 2:'', 3:'', 4:'', 5:''},
                    travelNotes: [], convKRW: null, convTWD: null, rate: 0.024
                }
            },
            computed: { totalSpent() { return (this.bills || []).reduce((sum, b) => sum + (Number(b.amount) || 0), 0); } },
            mounted() {
                db.ref(DATA_PATH).on('value', (s) => {
                    const data = s.val();
                    if (data) {
                        this.itinerary = data.itinerary || {1:[], 2:[], 3:[], 4:[], 5:[]};
                        this.bills = data.bills || [];
                        this.shoppingList = data.shoppingList || [];
                        this.dailySummaries = data.dailySummaries || {1:'', 2:'', 3:'', 4:'', 5:''};
                        this.travelNotes = data.travelNotes || [];
                    }
                });
            },
            methods: {
                sync() { db.ref(DATA_PATH).set({ itinerary: this.itinerary, bills: this.bills, shoppingList: this.shoppingList, dailySummaries: this.dailySummaries, travelNotes: this.travelNotes }); },
                updateConv(type) { if(type === 'KRW') this.convTWD = this.convKRW ? Math.round(this.convKRW * this.rate) : null; else this.convKRW = this.convTWD ? Math.round(this.convTWD / this.rate) : null; },
                getTransitIcon(t) { const icons = {walk:'fas fa-walking', car:'fas fa-taxi', bus:'fas fa-bus', plane:'fas fa-plane', subway:'fas fa-subway'}; return icons[t]; },
                toggleTransit(t) { let types = this.form.transitType ? this.form.transitType.split(',') : []; if(types.includes(t)) types = types.filter(i => i !== t); else types.push(t); this.form.transitType = types.join(','); },
                openAddModal() { this.isEditing = false; this.form = { time: '09:00', place: '', note: '', transitType: '', transitTime: '', transitUnit: 'm', mapUrl: '' }; this.showModal = true; },
                openEditModal(idx) { this.isEditing = true; this.editIndex = idx; this.form = {...this.itinerary[this.selectedDay][idx]}; this.showModal = true; },
                saveForm() { if(!this.itinerary[this.selectedDay]) this.itinerary[this.selectedDay] = []; if(this.isEditing) this.itinerary[this.selectedDay][this.editIndex] = {...this.form}; else this.itinerary[this.selectedDay].push({...this.form}); this.itinerary[this.selectedDay].sort((a,b) => a.time.localeCompare(b.time)); this.sync(); this.showModal = false; },
                deleteItem() { if(confirm('確定刪除？')) { this.itinerary[this.selectedDay].splice(this.editIndex, 1); this.sync(); this.showModal = false; } },
                openBillModal() { this.isEditBill = false; this.billForm = { itemName: '', amount: '', method: '現金', payer: 'Bibi', category: '食物', note: '' }; this.showBillModal = true; },
                editBill(idx) { this.isEditBill = true; this.editIndex = idx; this.billForm = {...this.bills[idx]}; this.showBillModal = true; },
                saveBill() { if(this.isEditBill) this.bills[this.editIndex] = {...this.billForm}; else this.bills.push({...this.billForm}); this.sync(); this.showBillModal = false; },
                deleteBill() { if(confirm('確定刪除？')) { this.bills.splice(this.editIndex, 1); this.sync(); this.showBillModal = false; } },
                openShopModal() { this.isEditShop = false; this.shopForm = { name: '', price: 0, category: '購物', imgBase64: '', isBought: false }; this.showShopModal = true; },
                editShopItem(id) { this.isEditShop = true; this.editIndex = this.shoppingList.findIndex(i => i.id === id); this.shopForm = {...this.shoppingList[this.editIndex]}; this.showShopModal = true; },
                saveShopItem() { if(this.isEditShop) this.shoppingList[this.editIndex] = {...this.shopForm}; else this.shoppingList.push({...this.shopForm, id: Date.now()}); this.sync(); this.showShopModal = false; },
                deleteShopItem() { if(confirm('確定刪除？')) { this.shoppingList.splice(this.editIndex, 1); this.sync(); this.showShopModal = false; } },
                toggleBought(id) { const item = this.shoppingList.find(i => i.id === id); if(item) { item.isBought = !item.isBought; this.sync(); } },
                handleFileUpload(e) { const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (f) => { this.shopForm.imgBase64 = f.target.result; }; reader.readAsDataURL(file); },
                openSummaryModal() { this.tempSummary = this.dailySummaries[this.selectedDay] || ''; this.showSummaryModal = true; },
                saveSummary() { this.dailySummaries[this.selectedDay] = this.tempSummary; this.sync(); this.showSummaryModal = false; },
                addNote() { this.travelNotes.push(''); this.sync(); },
                removeNote(idx) { if(confirm('確定刪除？')) { this.travelNotes.splice(idx, 1); this.sync(); } },
                moveNote(idx, step) { const newIdx = idx + step; if(newIdx < 0 || newIdx >= this.travelNotes.length) return; const temp = this.travelNotes[idx]; this.travelNotes[idx] = this.travelNotes[newIdx]; this.travelNotes[newIdx] = temp; this.sync(); },
                exportImage() {
                    const appElement = document.getElementById('app');
                    const header = document.getElementById('header-area');
                    appElement.classList.add('export-mode');
                    header.querySelectorAll('.export-only').forEach(el => el.style.display = 'block');
                    html2canvas(appElement, { useCORS: true, backgroundColor: "#f8fbfb", scale: 2, width: 375, windowWidth: 375 }).then(canvas => {
                        const link = document.createElement('a'); link.download = `Busan_Day${this.selectedDay}.png`; link.href = canvas.toDataURL('image/png'); link.click();
                        appElement.classList.remove('export-mode');
                        header.querySelectorAll('.export-only').forEach(el => el.style.display = 'none');
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>

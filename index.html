<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 busan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        :root {
            --primary: #8ABDBF;
            --bg-light: #F8FAFA;
            --text-dark: #334155;
            --card-white: #FFFFFF;
        }

        body {
            font-family: 'Montserrat', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            padding-bottom: 80px;
        }

        .header-bg {
            background-color: var(--primary);
            border-radius: 0 0 40px 40px;
            box-shadow: 0 4px 15px rgba(138, 189, 191, 0.2);
        }

        /* 日期按鈕優化：長度增加、字體大一點 */
        .date-btn {
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 90px; 
        }

        .date-btn.active {
            background: white;
            color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card {
            background: var(--card-white);
            border-radius: 24px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.03);
        }

        /* 鎖定正方形圖片容器 */
        .shop-img-container {
            width: 100%;
            padding-top: 100%; 
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            background: #f1f5f9;
        }

        .shop-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* 強制正方形填滿 */
        }

        .nav-bar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 50;
            align-items: flex-end;
        }

        .modal-content {
            background: white;
            width: 100%;
            border-radius: 30px 30px 0 0;
            padding: 24px;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal.active { display: flex; }
        .modal.active .modal-content { transform: translateY(0); }

        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div class="header-bg p-6 text-white text-center">
        <h1 class="text-2xl font-bold tracking-widest mb-4 lowercase">2026 busan <span class="text-xs opacity-50">v2.1</span></h1>
        <div class="flex justify-between gap-2 overflow-x-auto pb-2" id="dateTabs">
            </div>
    </div>

    <main class="p-5 max-w-md mx-auto" id="mainContent"></main>

    <nav class="nav-bar fixed bottom-0 left-0 right-0 h-20 flex justify-around items-center px-6 z-40">
        <button onclick="switchTab('plan')" class="nav-item flex flex-col items-center text-gray-400">
            <i class="fa-solid fa-calendar-alt text-xl mb-1"></i>
            <span class="text-[10px] font-bold">PLAN</span>
        </button>
        <button onclick="switchTab('wallet')" class="nav-item flex flex-col items-center text-gray-400">
            <i class="fa-solid fa-wallet text-xl mb-1"></i>
            <span class="text-[10px] font-bold">WALLET</span>
        </button>
        <div onclick="openAddModal()" class="bg-primary w-12 h-12 rounded-full flex items-center justify-center text-white shadow-lg -mt-10 border-4 border-white cursor-pointer">
            <i class="fa-solid fa-plus text-xl"></i>
        </div>
        <button onclick="switchTab('shop')" class="nav-item flex flex-col items-center text-gray-400">
            <i class="fa-solid fa-bag-shopping text-xl mb-1"></i>
            <span class="text-[10px] font-bold">SHOP</span>
        </button>
    </nav>

    <div id="addModal" class="modal" onclick="closeAddModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="modalFormContainer"></div>
        </div>
    </div>

    <script>
        // --- 初始化資料 ---
        let currentTab = 'plan';
        let selectedDate = '2/17';
        const dates = ['2/17', '2/18', '2/19', '2/20', '2/21'];
        const weekDays = ['二', '三', '四', '五', '六'];

        let tripData = JSON.parse(localStorage.getItem('busanTripData_v2.1')) || {
            plans: {},
            wallets: {},
            shops: { '食物': [], '購物': [], '美妝': [], '交通': [], '其他': [] },
            memos: []
        };

        function saveData() {
            localStorage.setItem('busanTripData_v2.1', JSON.stringify(tripData));
            render();
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-item').forEach(item => {
                const isActive = item.getAttribute('onclick').includes(tab);
                item.classList.toggle('text-[#8ABDBF]', isActive);
                item.classList.toggle('text-gray-400', !isActive);
            });
            render();
        }

        function render() {
            const container = document.getElementById('mainContent');
            container.innerHTML = '';
            if (currentTab === 'plan') renderPlan(container);
            else if (currentTab === 'wallet') renderWallet(container);
            else if (currentTab === 'shop') renderShop(container);
        }

        // --- 行程 PLAN ---
        function renderPlan(container) {
            const dayPlans = tripData.plans[selectedDate] || [];
            let html = `<div class="space-y-4">`;
            dayPlans.forEach((plan, idx) => {
                html += `
                    <div class="card p-4 flex gap-4 items-center relative">
                        <div class="text-primary font-bold text-sm w-12">${plan.time}</div>
                        <div class="flex-1">
                            <div class="font-bold">${plan.title}</div>
                            <div class="text-xs text-gray-400">${plan.memo || ''}</div>
                        </div>
                        <button onclick="deleteItem('plans', '${selectedDate}', ${idx})" class="text-gray-300"><i class="fa-solid fa-xmark"></i></button>
                    </div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        // --- 錢包 WALLET (保留台幣備註與項目備註) ---
        function renderWallet(container) {
            const logs = tripData.wallets[selectedDate] || [];
            let totalKRW = logs.reduce((sum, log) => sum + Number(log.amount), 0);
            let totalTWD = Math.round(totalKRW * 0.024);

            let html = `
                <div class="bg-[#8ABDBF] rounded-[30px] p-6 text-white mb-6 text-center shadow-lg">
                    <p class="text-[10px] opacity-80 mb-1 tracking-widest">TOTAL SPENT</p>
                    <h2 class="text-3xl font-bold mb-1">₩ ${totalKRW.toLocaleString()}</h2>
                    <p class="text-sm opacity-90">≈ NT$ ${totalTWD.toLocaleString()}</p>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-white p-3 rounded-2xl text-center border border-slate-50">
                        <p class="text-[10px] text-gray-400">大比</p>
                        <p class="font-bold text-primary">₩ ${logs.filter(l => l.payer === '大比').reduce((s, l) => s + Number(l.amount), 0).toLocaleString()}</p>
                    </div>
                    <div class="bg-white p-3 rounded-2xl text-center border border-slate-50">
                        <p class="text-[10px] text-gray-400">小比</p>
                        <p class="font-bold text-primary">₩ ${logs.filter(l => l.payer === '小比').reduce((s, l) => s + Number(l.amount), 0).toLocaleString()}</p>
                    </div>
                </div>

                <div class="space-y-3">`;
            
            logs.forEach((log, idx) => {
                html += `
                    <div class="card p-4 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-primary">
                                <i class="fa-solid ${log.type === 'CARD' ? 'fa-credit-card' : 'fa-money-bill-1'}"></i>
                            </div>
                            <div>
                                <div class="font-bold text-sm">${log.title}</div>
                                <div class="text-[10px] text-gray-400">${log.category} · ${log.payer}</div>
                                ${log.memo ? `<div class="text-[10px] text-orange-400 mt-1 italic">註：${log.memo}</div>` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-sm">₩ ${Number(log.amount).toLocaleString()}</div>
                            <button onclick="deleteItem('wallets', '${selectedDate}', ${idx})" class="text-gray-300 text-xs mt-1"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>`;
            });

            html += `</div>
                <div class="mt-8 bg-white p-5 rounded-[24px]">
                    <p class="text-[10px] text-gray-400 mb-3 font-bold uppercase tracking-widest">Currency Converter</p>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <span class="text-xs font-bold text-slate-400">KRW</span>
                            <input type="number" id="calcKRW" placeholder="輸入韓元" class="bg-transparent text-right font-bold w-full outline-none" oninput="convertCurrency('KRW')">
                        </div>
                        <div class="flex justify-center text-gray-200"><i class="fa-solid fa-arrows-rotate"></i></div>
                        <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <span class="text-xs font-bold text-slate-400">TWD</span>
                            <input type="number" id="calcTWD" placeholder="輸入台幣" class="bg-transparent text-right font-bold w-full outline-none" oninput="convertCurrency('TWD')">
                        </div>
                    </div>
                </div>`;
            container.innerHTML = html;
        }

        // --- 購物 SHOP (鎖定正方形圖片＋備註) ---
        function renderShop(container) {
            let html = `<div class="space-y-4">`;
            for (let cat in tripData.shops) {
                html += `
                    <div class="bg-white rounded-2xl overflow-hidden shadow-sm">
                        <button onclick="this.nextElementSibling.classList.toggle('hidden')" class="w-full p-4 flex justify-between items-center font-bold text-sm border-b border-gray-50">
                            <span>${cat} (${tripData.shops[cat].length})</span>
                            <i class="fa-solid fa-chevron-down text-gray-300 text-xs"></i>
                        </button>
                        <div class="hidden p-4 grid grid-cols-2 gap-4 bg-gray-50/50">`;
                
                tripData.shops[cat].forEach((item, idx) => {
                    html += `
                        <div class="bg-white p-2 rounded-2xl shadow-sm relative">
                            <div class="shop-img-container mb-2">
                                ${item.img ? `<img src="${item.img}" class="shop-img">` : `<div class="shop-img flex items-center justify-center bg-slate-100"><i class="fa-solid fa-image text-gray-300"></i></div>`}
                            </div>
                            <div class="px-1">
                                <div class="font-bold text-xs truncate">${item.name}</div>
                                <div class="text-[10px] text-primary mb-1">₩ ${Number(item.price).toLocaleString()}</div>
                                ${item.memo ? `<div class="text-[9px] text-gray-400 bg-slate-50 p-1 rounded italic leading-tight">${item.memo}</div>` : ''}
                            </div>
                            <button onclick="deleteShopItem('${cat}', ${idx})" class="absolute top-1 right-1 bg-black/20 text-white w-5 h-5 rounded-full text-[10px]"><i class="fa-solid fa-xmark"></i></button>
                        </div>`;
                });

                html += `</div></div>`;
            }
            
            // 備忘錄區塊
            html += `<div class="mt-8"><p class="font-bold mb-4 text-slate-400 text-xs tracking-widest">MEMO</p>`;
            tripData.memos.forEach((memo, idx) => {
                html += `
                    <div class="card p-4 mb-3 relative">
                        <div class="text-[10px] font-bold text-primary mb-1">${memo.tag}</div>
                        <div class="text-sm whitespace-pre-wrap leading-relaxed">${memo.content}</div>
                        <button onclick="deleteMemo(${idx})" class="absolute top-4 right-4 text-gray-200"><i class="fa-solid fa-xmark"></i></button>
                    </div>`;
            });
            html += `</div></div>`;
            container.innerHTML = html;
        }

        // --- 功能函數 ---
        function convertCurrency(type) {
            const krwIn = document.getElementById('calcKRW');
            const twdIn = document.getElementById('calcTWD');
            if(type === 'KRW') twdIn.value = Math.round(krwIn.value * 0.024);
            else krwIn.value = Math.round(twdIn.value / 0.024);
        }

        function deleteItem(type, date, idx) { if(confirm('確定刪除？')) { tripData[type][date].splice(idx, 1); saveData(); } }
        function deleteShopItem(cat, idx) { if(confirm('要移出清單嗎？')) { tripData.shops[cat].splice(idx, 1); saveData(); } }
        function deleteMemo(idx) { if(confirm('確定刪除？')) { tripData.memos.splice(idx, 1); saveData(); } }

        // --- 表單控制 ---
        function openAddModal() {
            const fc = document.getElementById('modalFormContainer');
            if (currentTab === 'plan') {
                fc.innerHTML = `
                    <h3 class="font-bold mb-4">新增行程</h3>
                    <input type="time" id="planTime" class="w-full p-3 bg-gray-100 rounded-xl mb-3 outline-none" value="12:00">
                    <input type="text" id="planTitle" placeholder="行程名稱" class="w-full p-3 bg-gray-100 rounded-xl mb-3 outline-none">
                    <input type="text" id="planMemo" placeholder="行程備註" class="w-full p-3 bg-gray-100 rounded-xl mb-6 outline-none">
                    <button onclick="saveNewPlan()" class="w-full py-4 bg-[#8ABDBF] text-white rounded-xl font-bold">儲存</button>`;
            } else if (currentTab === 'wallet') {
                fc.innerHTML = `
                    <h3 class="font-bold mb-4">新增支出</h3>
                    <input type="text" id="payTitle" placeholder="項目名稱" class="w-full p-3 bg-gray-100 rounded-xl mb-3 outline-none">
                    <input type="number" id="payAmount" placeholder="金額 (KRW)" class="w-full p-3 bg-gray-100 rounded-xl mb-3 outline-none">
                    <select id="payCat" class="w-full p-3 bg-gray-100 rounded-xl mb-3 outline-none">
                        <option>食物</option><option>購物</option><option>美妝</option><option>交通</option><option>其他</option>
                    </select>
                    <div class="flex gap-2 mb-3">
                        <select id="payPayer" class="flex-1 p-3 bg-gray-100 rounded-xl outline-none"><option>大比</option><option>小比</option></select>
                        <select id="payType" class="flex-1 p-3 bg-gray-100 rounded-xl outline-none"><option>CASH</option><option>CARD</option></select>
                    </div>
                    <input type="text" id="payMemo" placeholder="支出備註" class="w-full p-3 bg-gray-100 rounded-xl mb-6 outline-none">
                    <button onclick="saveNewPay()" class="w-full py-4 bg-[#8ABDBF] text-white rounded-xl font-bold">儲存</button>`;
            } else {
                fc.innerHTML = `
                    <div class="flex gap-4 mb-6">
                        <button onclick="toggleShopForm('item')" id="btnShopItem" class="font-bold text-primary">購物清單</button>
                        <button onclick="toggleShopForm('memo')" id="btnShopMemo" class="font-bold text-gray-300">備忘錄</button>
                    </div>
                    <div id="shopItemForm">
                        <input type="text" id="shopName" placeholder="商品名稱" class="w-full p-3 bg-gray-100 rounded-xl mb-3 outline-none">
                        <input type="number" id="shopPrice" placeholder="金額" class="w-full p-3 bg-gray-100 rounded-xl mb-3 outline-none">
                        <select id="shopCat" class="w-full p-3 bg-gray-100 rounded-xl mb-3 outline-none">
                            <option>食物</option><option>購物</option><option>美妝</option><option>其他</option>
                        </select>
                        <input type="text" id="shopMemo" placeholder="商品備註" class="w-full p-3 bg-gray-100 rounded-xl mb-3 outline-none">
                        <div class="w-full h-12 border-2 border-dashed border-gray-200 rounded-xl flex items-center justify-center mb-6 relative">
                            <span class="text-xs text-gray-400">上傳圖片</span>
                            <input type="file" accept="image/*" class="absolute inset-0 opacity-0" onchange="handleImgUpload(this)">
                        </div>
                        <button onclick="saveNewShopItem()" class="w-full py-4 bg-[#8ABDBF] text-white rounded-xl font-bold">儲存項目</button>
                    </div>
                    <div id="shopMemoForm" class="hidden">
                        <textarea id="memoContent" class="w-full p-3 bg-gray-100 rounded-xl mb-3 h-32 outline-none" placeholder="輸入備忘錄內容..."></textarea>
                        <input type="text" id="memoTag" placeholder="標籤 (如: 交通、必看)" class="w-full p-3 bg-gray-100 rounded-xl mb-6 outline-none">
                        <button onclick="saveNewMemo()" class="w-full py-4 bg-[#8ABDBF] text-white rounded-xl font-bold">儲存 MEMO</button>
                    </div>`;
            }
            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal() { document.getElementById('addModal').classList.remove('active'); tempImg = null; }

        function saveNewPlan() {
            const time = document.getElementById('planTime').value;
            const title = document.getElementById('planTitle').value;
            const memo = document.getElementById('planMemo').value;
            if(!title) return;
            if(!tripData.plans[selectedDate]) tripData.plans[selectedDate] = [];
            tripData.plans[selectedDate].push({ time, title, memo });
            tripData.plans[selectedDate].sort((a,b) => a.time.localeCompare(b.time));
            saveData(); closeAddModal();
        }

        function saveNewPay() {
            const title = document.getElementById('payTitle').value;
            const amount = document.getElementById('payAmount').value;
            const category = document.getElementById('payCat').value;
            const payer = document.getElementById('payPayer').value;
            const type = document.getElementById('payType').value;
            const memo = document.getElementById('payMemo').value;
            if(!title || !amount) return;
            if(!tripData.wallets[selectedDate]) tripData.wallets[selectedDate] = [];
            tripData.wallets[selectedDate].push({ title, amount, category, payer, type, memo });
            saveData(); closeAddModal();
        }

        let tempImg = null;
        function handleImgUpload(input) {
            const file = input.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => tempImg = e.target.result;
                reader.readAsDataURL(file);
                input.previousElementSibling.innerText = "✅ 圖片已選取";
            }
        }

        function saveNewShopItem() {
            const name = document.getElementById('shopName').value;
            const price = document.getElementById('shopPrice').value;
            const cat = document.getElementById('shopCat').value;
            const memo = document.getElementById('shopMemo').value;
            if(!name) return;
            tripData.shops[cat].push({ name, price, img: tempImg, memo });
            saveData(); closeAddModal();
        }

        function saveNewMemo() {
            const content = document.getElementById('memoContent').value;
            const tag = document.getElementById('memoTag').value || '一般';
            if(!content) return;
            tripData.memos.push({ content, tag });
            saveData(); closeAddModal();
        }

        function toggleShopForm(type) {
            document.getElementById('shopItemForm').classList.toggle('hidden', type === 'memo');
            document.getElementById('shopMemoForm').classList.toggle('hidden', type === 'item');
            document.getElementById('btnShopItem').className = type === 'item' ? 'font-bold text-primary' : 'font-bold text-gray-300';
            document.getElementById('btnShopMemo').className = type === 'memo' ? 'font-bold text-primary' : 'font-bold text-gray-300';
        }

        // --- 初始化日期按鈕 ---
        const dateTabs = document.getElementById('dateTabs');
        dates.forEach((date, i) => {
            const btn = document.createElement('button');
            btn.className = `date-btn min-w-[65px] p-3 rounded-2xl flex flex-col items-center justify-center ${date === selectedDate ? 'active' : ''}`;
            btn.innerHTML = `<span class="text-sm opacity-60 mb-1 font-bold">${date}</span><span class="text-xl font-bold">${weekDays[i]}</span>`;
            btn.onclick = () => {
                selectedDate = date;
                document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                render();
            };
            dateTabs.appendChild(btn);
        });

        // 啟動首頁渲染
        switchTab('plan');
    </script>
</body>
</html>

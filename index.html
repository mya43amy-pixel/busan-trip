<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 busan</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuedraggable@4.1.0/dist/vuedraggable.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: #f8fbfb; -webkit-tap-highlight-color: transparent; }
        .teal-theme { background-color: #78B7BB; }
        .teal-text { color: #78B7BB; }
        .active-tab { color: #78B7BB !important; font-weight: bold; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .input-round { border-radius: 12px; border: 1px solid #eef2f2; padding: 12px; outline: none; background: #f9fbfb; width: 100%; font-size: 14px; }
        .card-pop { border-radius: 20px; background: white; box-shadow: 0 4px 12px rgba(120, 183, 187, 0.06); }
        .card-bought { opacity: 0.5; filter: grayscale(0.8); }
        [v-cloak] { display: none; }
        .summary-box { background-color: #F0F7F7; border: 1px solid #E2EEEE; }
        .subtle-note { font-size: 11px; color: #9ca3af; margin-top: 4px; line-height: 1.4; } /* 唯一更動：輕量化備註 */
        
        /* 交通工具按鈕樣式 */
        .transit-btn { width: 42px; height: 42px; border-radius: 12px; display: flex; align-items: center; justify-content: center; background: #f3f4f6; color: #d1d5db; transition: all 0.2s; border: none; }
        .transit-btn.active { background: #78B7BB; color: white; box-shadow: 0 4px 10px rgba(120, 183, 187, 0.3); }

        /* 旅伴統計卡片 */
        .member-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px; }
        .member-mini-card { background: rgba(255, 255, 255, 0.15); border-radius: 15px; padding: 10px; text-align: center; }
        .member-mini-card:first-child { grid-column: span 2; background: rgba(255, 255, 255, 0.25); } /* 共同佔滿一列 */
    </style>
</head>
<body>
    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen pb-28 relative bg-[#f8fbfb]">
        <header class="teal-theme pt-6 pb-4 px-4 text-white rounded-b-[35px] shadow-lg sticky top-0 z-50">
            <h1 class="text-center text-base font-black tracking-[0.3em] mb-4 uppercase">2026 busan</h1>
            <div class="flex justify-center items-center gap-2 overflow-x-auto no-scrollbar px-1">
                <div v-for="(d, i) in dateConfig" :key="i" @click="selectedDay = (i+1)"
                    :class="selectedDay === (i+1) ? 'bg-white text-[#78B7BB] shadow-md' : 'bg-white/20 text-white'"
                    class="min-w-[65px] h-16 rounded-[20px] flex flex-col items-center justify-center cursor-pointer transition-all">
                    <span class="text-base font-extrabold">{{d.date.split('/')[1]}}</span>
                    <span class="text-xs font-bold">{{d.day}}</span>
                </div>
            </div>
        </header>

        <main class="p-5">
            <div v-show="activeTab === 'itinerary'" class="space-y-6">
                <div @click="openSummaryModal" class="summary-box w-full py-4 px-6 rounded-2xl text-center cursor-pointer">
                    <p class="teal-text font-bold text-sm uppercase tracking-widest">{{ dailySummaries[selectedDay] || '點擊編輯今日大綱...' }}</p>
                </div>
                <div v-for="(item, index) in (itinerary[selectedDay] || [])" :key="index">
                    <div v-if="item.transitTime || item.transitType" class="flex items-center gap-2 ml-8 mb-2 text-[12px] text-gray-400 font-bold">
                        <span class="flex gap-1.5"><i v-for="t in (item.transitType ? item.transitType.split(',') : [])" :key="t" :class="getTransitIcon(t)"></i></span>
                        <span v-if="item.transitTime">{{item.transitTime}}{{item.transitUnit}}</span>
                    </div>
                    <div @click="openEditModal(index)" class="p-5 card-pop border border-gray-50 flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2.5">
                                <span class="text-[12px] font-black px-2.5 py-1 bg-teal-50 teal-text rounded-md">{{item.time}}</span>
                                <a v-if="item.mapUrl" :href="item.mapUrl" target="_blank" @click.stop class="w-7 h-7 flex items-center justify-center bg-gray-100 rounded-full text-xs teal-text"><i class="fas fa-link"></i></a>
                            </div>
                            <h3 class="font-bold text-lg mt-2.5 text-gray-800">{{item.place}}</h3>
                            <p v-if="item.note" class="subtle-note whitespace-pre-wrap">{{item.note}}</p>
                        </div>
                        <div v-if="item.stayTime" class="text-right">
                            <div class="text-[10px] bg-gray-50 px-2 py-1 rounded-md text-gray-400 font-bold"><i class="far fa-clock mr-1"></i>停留 {{item.stayTime}}{{item.stayUnit}}</div>
                        </div>
                    </div>
                </div>
                <button @click="openAddModal" class="w-full py-4 border-2 border-dashed border-teal-100 rounded-[24px] text-teal-200 font-bold">+ 新增行程</button>
            </div>

            <div v-show="activeTab === 'wallet'" class="space-y-6">
                <div class="bg-[#78B7BB] p-6 rounded-[30px] text-white shadow-xl text-center">
                    <p class="text-[10px] opacity-80 font-bold uppercase tracking-widest">Total Spent</p>
                    <h2 class="text-4xl font-black mb-1">₩ {{totalSpent.toLocaleString()}}</h2>
                    <p class="text-sm opacity-70 font-bold mb-4"> ≈ NT$ {{Math.round(totalSpent * rate).toLocaleString()}}</p>
                    <div class="bg-white/10 rounded-2xl p-3 mb-6 text-xs font-bold">現金餘額: ₩ {{balance.toLocaleString()}}</div>
                    
                    <div class="member-stats-grid">
                        <div v-for="m in members" :key="m" class="member-mini-card">
                            <p class="text-[10px] opacity-70 mb-1">{{m}}</p>
                            <p class="text-sm font-bold">₩ {{getMemberTotal(m).toLocaleString()}}</p>
                            <p class="text-[9px] opacity-50">NT$ {{Math.round(getMemberTotal(m) * rate).toLocaleString()}}</p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center px-2">
                    <span class="text-[10px] text-gray-400 font-bold"><i class="fas fa-sync-alt mr-1"></i>當前匯率: {{rate}}</span>
                    <button @click="manageMembers" class="text-[10px] teal-text font-bold"><i class="fas fa-users-cog mr-1"></i>成員管理</button>
                </div>

                <div class="space-y-3">
                    <div v-for="(element, index) in bills" :key="index" @click="editBill(index)" class="card-pop p-4 border border-gray-50 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-teal-50 flex items-center justify-center teal-text">
                                <i :class="element.type === 'income' ? 'fas fa-hand-holding-usd' : 'fas fa-receipt'"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 text-sm">{{element.itemName}}</p>
                                <p class="text-[10px] text-gray-400 font-bold">{{element.payer}} · {{element.category}}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-black text-sm" :class="element.type === 'income' ? 'text-orange-400' : 'text-gray-700'">₩ {{element.amount.toLocaleString()}}</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-[30px] card-pop mt-6">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>

            <div v-show="activeTab === 'tools'" class="space-y-8">
                <div v-for="cat in ['食物', '購物', '美妝', '其他']" :key="cat" class="space-y-3">
                    <h3 class="font-black text-gray-700 text-sm px-2">{{cat}}</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div v-for="item in getCatItems(cat)" :key="item.id" @click="editShopItem(item.id)" class="card-pop overflow-hidden relative" :class="{'card-bought': item.isBought}">
                            <div class="aspect-square bg-gray-50 flex items-center justify-center">
                                <img v-if="item.imgBase64" :src="item.imgBase64" class="w-full h-full object-cover">
                                <i v-else class="fas fa-shopping-bag text-gray-200"></i>
                            </div>
                            <div class="p-3"><h4 class="font-bold text-xs truncate">{{item.name}}</h4></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div v-if="showModal" class="fixed inset-0 bg-black/60 z-[60] flex items-end">
            <div class="bg-white w-full rounded-t-[40px] p-8 pb-12">
                <div class="flex justify-between mb-8"><h3 class="text-xl font-black">行程細節</h3><button @click="showModal = false"><i class="fas fa-times"></i></button></div>
                <div class="space-y-5">
                    <div class="flex gap-4">
                        <input type="time" v-model="form.time" class="input-round font-bold teal-text">
                        <input v-model="form.place" placeholder="地點" class="input-round">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-gray-400 mb-2">交通方式 (可複選)</label>
                        <div class="flex gap-3 overflow-x-auto no-scrollbar py-1">
                            <button v-for="t in ['walk','bus','subway','car','plane']" :key="t" @click="toggleTransit(t)" :class="{'active': (form.transitType || '').split(',').includes(t)}" class="transit-btn">
                                <i :class="getTransitIcon(t)"></i>
                            </button>
                        </div>
                    </div>
                    <textarea v-model="form.note" class="input-round h-24" placeholder="備註..."></textarea>
                    <button @click="saveForm" class="w-full py-4 teal-theme text-white rounded-2xl font-black">儲存</button>
                </div>
            </div>
        </div>

        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-100 flex justify-around py-5 rounded-t-[35px] z-40">
            <button @click="activeTab = 'itinerary'" :class="{'active-tab': activeTab === 'itinerary'}" class="flex flex-col items-center text-gray-300">
                <i class="fas fa-calendar-alt text-xl"></i><span class="text-[9px] mt-1 font-black">PLAN</span>
            </button>
            <button @click="activeTab = 'wallet'" :class="{'active-tab': activeTab === 'wallet'}" class="flex flex-col items-center text-gray-300">
                <i class="fas fa-wallet text-xl"></i><span class="text-[9px] mt-1 font-black">WALLET</span>
            </button>
            <button @click="activeTab = 'tools'" :class="{'active-tab': activeTab === 'tools'}" class="flex flex-col items-center text-gray-300">
                <i class="fas fa-shopping-bag text-xl"></i><span class="text-[9px] mt-1 font-black">SHOP</span>
            </button>
        </nav>
    </div>

    <script>
        const { createApp } = Vue;
        const firebaseConfig = { apiKey: "AIzaSyAqfcjA5QuZlDibAJlkJL7IJvj4zwxyjPM", authDomain: "busan-trip-bibi.firebaseapp.com", databaseURL: "https://busan-trip-bibi-default-rtdb.firebaseio.com", projectId: "busan-trip-bibi" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        createApp({
            data() {
                return {
                    activeTab: 'itinerary', selectedDay: 1, rate: 0.0238,
                    showModal: false, isEditing: false, editIndex: null,
                    dateConfig: [{date: '2/17', day: '二'}, {date: '2/18', day: '三'}, {date: '2/19', day: '四'}, {date: '2/20', day: '五'}, {date: '2/21', day: '六'}],
                    form: { time: '09:00', place: '', note: '', transitType: '', transitTime: '', transitUnit: 'm', stayTime: '', stayUnit: 'm', mapUrl: '' },
                    itinerary: {1:[], 2:[], 3:[], 4:[], 5:[]}, bills: [], shoppingList: [], dailySummaries: {}, members: ['共同', '大比', '小比']
                }
            },
            computed: {
                totalSpent() { return this.bills.reduce((sum, b) => sum + (Number(b.amount) || 0), 0); },
                cashSpent() { return this.bills.filter(b => b.method === '現金').reduce((sum, b) => sum + (Number(b.amount) || 0), 0); },
                balance() { return 0; } // 依據實際計算邏輯調整
            },
            mounted() {
                db.ref('busan_trip_final').on('value', (s) => {
                    const data = s.val();
                    if (data) {
                        this.itinerary = data.itinerary || {1:[], 2:[], 3:[], 4:[], 5:[]};
                        this.bills = data.bills || [];
                        this.shoppingList = data.shoppingList || [];
                        this.members = data.members || ['共同', '大比', '小比'];
                    }
                });
            },
            methods: {
                getMemberTotal(name) {
                    return this.bills.filter(b => b.payer === name).reduce((sum, b) => sum + (Number(b.amount) || 0), 0);
                },
                getTransitIcon(t) { return {walk:'fas fa-walking', car:'fas fa-taxi', bus:'fas fa-bus', plane:'fas fa-plane', subway:'fas fa-subway'}[t.trim()] || 'fas fa-chevron-right'; },
                toggleTransit(t) {
                    let types = this.form.transitType ? this.form.transitType.split(',').filter(x => x) : [];
                    if(types.includes(t)) types = types.filter(x => x !== t); else types.push(t);
                    this.form.transitType = types.join(',');
                },
                openAddModal() { this.isEditing = false; this.form = { time: '09:00', place: '', note: '', transitType: '' }; this.showModal = true; },
                saveForm() { 
                    if(!this.itinerary[this.selectedDay]) this.itinerary[this.selectedDay] = [];
                    this.itinerary[this.selectedDay].push({...this.form});
                    this.sync(); this.showModal = false; 
                },
                sync() { db.ref('busan_trip_final').update({ itinerary: this.itinerary, bills: this.bills, shoppingList: this.shoppingList, members: this.members }); },
                getCatItems(c) { return this.shoppingList.filter(i => i.category === c); }
            }
        }).mount('#app');
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Busan Trip - Bibi</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'PingFang TC', sans-serif; background-color: #f8fbfb; }
        .teal-theme { background-color: #78B7BB; }
        .teal-text { color: #78B7BB; }
        .active-tab { color: #78B7BB !important; font-weight: bold; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .day-box {
            min-width: 65px; height: 75px; border-radius: 14px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.3s ease; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.2);
        }
        .day-box.active {
            background-color: white; color: #78B7BB;
            transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        .day-box.inactive { background-color: rgba(255,255,255,0.2); color: white; }
        .input-round { border-radius: 14px; border: 1px solid #eef2f2; padding: 12px; outline: none; background: #f9fbfb; width: 100%; font-size: 14px; }
        .card-pop { border-radius: 28px; background: white; box-shadow: 0 10px 25px rgba(120, 183, 187, 0.08); }
        [v-cloak] { display: none; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>
</head>
<body>
    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen pb-28 relative bg-white shadow-2xl overflow-hidden">
        
        <header class="teal-theme pt-12 pb-8 px-4 text-white rounded-b-[45px] shadow-lg">
            <h1 class="text-center text-xl font-bold tracking-widest mb-6">BUSAN 2/17-2/21 âš“ï¸</h1>
            <div class="flex justify-center items-center gap-3 overflow-x-auto no-scrollbar px-2">
                <div v-for="(d, idx) in dateInfo" :key="idx" 
                     @click="selectedDay = idx + 1"
                     :class="selectedDay === idx + 1 ? 'active' : 'inactive'"
                     class="day-box cursor-pointer">
                    <span class="text-[10px] opacity-80 mb-1">{{d.date}}</span>
                    <span class="text-lg font-black leading-none">{{idx + 1}}</span>
                    <span class="text-[10px] mt-1 font-medium">{{d.week}}</span>
                </div>
            </div>
        </header>

        <main class="p-5">
            <div v-if="activeTab === 'itinerary'" class="space-y-4">
                <div id="capture-area" class="space-y-4 bg-white p-2">
                    <div class="flex justify-between items-center px-1">
                        <h2 class="font-black text-gray-700 text-lg">Day {{selectedDay}} Schedule</h2>
                    </div>
                    <div v-for="(item, index) in itinerary[selectedDay]" :key="index" 
                         @click="openEditModal(index)"
                         class="p-5 card-pop border border-gray-50 active:scale-[0.98] transition-all mb-4">
                        <div class="flex justify-between items-start">
                            <span class="text-[10px] font-bold px-2 py-1 bg-teal-50 teal-text rounded-lg">{{item.time}}</span>
                            <button @click.stop="deleteItem(index)" class="text-gray-200"><i class="fas fa-times-circle"></i></button>
                        </div>
                        <h3 class="font-bold text-gray-800 text-lg mt-2">{{item.place}}</h3>
                        <p class="text-xs text-gray-400 mt-1">{{item.note}}</p>
                        <div class="mt-4 flex items-center justify-between border-t pt-4 border-gray-50">
                            <span class="text-[11px] text-gray-500"><i :class="getTransportIcon(item.transport)" class="mr-1 teal-text"></i>é€šè»Š {{item.travelTime}}{{item.travelUnit}}</span>
                            <a v-if="item.mapUrl" :href="item.mapUrl" target="_blank" @click.stop class="w-8 h-8 flex items-center justify-center bg-teal-50 rounded-full teal-text"><i class="fas fa-paper-plane text-xs"></i></a>
                        </div>
                    </div>
                </div>
                <button @click="openAddModal" class="w-full py-4 border-2 border-dashed border-teal-100 rounded-[24px] text-teal-200 font-bold">+ æ–°å¢è¡Œç¨‹</button>
                <button @click="exportToImg" class="w-full py-4 mt-6 bg-gray-800 text-white rounded-2xl font-black shadow-lg"><i class="fas fa-file-download mr-2"></i>åŒ¯å‡ºä»Šæ—¥è¡Œç¨‹åœ–ç‰‡</button>
            </div>

            <div v-if="activeTab === 'wallet'" class="space-y-6">
                <div class="bg-gradient-to-br from-[#78B7BB] to-[#95d1d5] p-7 rounded-[35px] text-white shadow-xl">
                    <p class="text-xs text-center opacity-80 mb-1 font-bold">ç¸½èŠ±è²» (KRW)</p>
                    <h2 class="text-4xl font-black text-center mb-6">â‚© {{totalSpent.toLocaleString()}}</h2>
                    <div class="grid grid-cols-2 gap-4 border-t border-white/20 pt-4">
                        <div v-for="member in members" :key="member" class="text-center">
                            <p class="text-[10px] opacity-70">{{member}} æ”¯å‡º</p>
                            <p class="text-sm font-bold">â‚© {{getMemberTotal(member).toLocaleString()}}</p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between items-center bg-teal-50 p-4 rounded-2xl">
                    <span class="text-xs font-bold teal-text">æ—…ä¼´ï¼š{{members.join(', ')}}</span>
                    <button @click="manageMembers" class="text-[10px] bg-white teal-text px-3 py-1 rounded-full shadow-sm font-bold">ç·¨è¼¯æ—…ä¼´</button>
                </div>
                <div v-for="(bill, index) in bills" :key="index" class="bg-white p-5 rounded-2xl flex justify-between items-center shadow-sm">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-teal-50 flex items-center justify-center teal-text"><i :class="getCategoryIcon(bill.category)"></i></div>
                        <div>
                            <p class="font-bold text-gray-800 text-sm">{{bill.itemName}}</p>
                            <p class="text-[10px] text-gray-400">{{bill.store}} Â· {{bill.payer}}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-black text-sm text-gray-700">â‚© {{bill.amount.toLocaleString()}}</p>
                    </div>
                </div>
                <button @click="openBillModal" class="fixed bottom-28 right-6 w-16 h-16 teal-theme text-white rounded-full shadow-2xl flex items-center justify-center text-2xl border-4 border-white"><i class="fas fa-plus"></i></button>
            </div>

            <div v-if="activeTab === 'tools'" class="space-y-6">
                <div class="bg-white p-6 rounded-[30px] shadow-sm">
                    <h3 class="font-black mb-4 teal-text text-sm">åŒ¯ç‡æ›ç®—</h3>
                    <div class="flex items-center gap-4 bg-gray-50 p-4 rounded-2xl mb-3">
                        <input type="number" v-model="calcKrw" class="bg-transparent flex-1 font-black text-xl outline-none" placeholder="è¼¸å…¥éŸ“å…ƒ">
                        <span class="text-xs text-gray-300">KRW</span>
                    </div>
                    <div class="flex items-center gap-4 bg-teal-50 p-4 rounded-2xl">
                        <div class="flex-1 font-black text-xl teal-text">{{Math.round(calcKrw * 0.024).toLocaleString()}}</div>
                        <span class="text-xs teal-text">TWD</span>
                    </div>
                </div>
            </div>
        </main>

        <div v-if="showBillModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end z-50">
            <div class="bg-white w-full rounded-t-[45px] p-8 pb-12 animate-up">
                <h3 class="font-black text-xl mb-6">æ–°å¢æ”¯å‡º ğŸ’¸</h3>
                <div class="space-y-4">
                    <input v-model="billForm.itemName" placeholder="è¼¸å…¥å“å" class="input-round font-bold">
                    <input v-model="billForm.store" placeholder="è¼¸å…¥è³¼è²·é€šè·¯" class="input-round">
                    <div class="flex gap-2">
                        <input v-model.number="billForm.amount" type="number" placeholder="é‡‘é¡ (KRW)" class="input-round font-black">
                        <select v-model="billForm.payer" class="input-round w-32 font-bold">
                            <option v-for="m in members" :key="m" :value="m">{{m}}</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <select v-model="billForm.category" class="input-round">
                            <option value="food">ğŸ´ é£Ÿç‰©</option><option value="shop">ğŸ›ï¸ è³¼ç‰©</option><option value="other">âœ¨ å…¶ä»–</option>
                        </select>
                        <select v-model="billForm.method" class="input-round">
                            <option value="card">ğŸ’³ åˆ·å¡</option><option value="cash">ğŸ’µ ç¾é‡‘</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-4 mt-8">
                    <button @click="showBillModal = false" class="flex-1 py-4 bg-gray-50 rounded-2xl font-bold text-gray-400">å–æ¶ˆ</button>
                    <button @click="saveBill" class="flex-[2] py-4 teal-theme text-white rounded-2xl font-black">ç¢ºèªæ–°å¢</button>
                </div>
            </div>
        </div>

        <div v-if="showModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end z-50">
            <div class="bg-white w-full rounded-t-[45px] p-8 pb-12 animate-up">
                <h3 class="font-black text-xl mb-6">{{isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢æ™¯é»'}} ğŸ“</h3>
                <div class="space-y-4">
                    <input v-model="form.place" placeholder="åœ°é»åç¨±" class="input-round font-bold text-lg">
                    <div class="flex gap-2">
                        <input v-model="form.time" type="time" class="input-round font-black">
                        <div class="flex-1 flex gap-1">
                            <input v-model="form.stayTime" class="w-12 input-round text-center px-1">
                            <select v-model="form.stayUnit" class="flex-1 input-round text-xs font-bold"><option value="m">min</option><option value="h">hour</option></select>
                        </div>
                    </div>
                    <input v-model="form.mapUrl" placeholder="åœ°åœ–é€£çµ (Naver/Google)" class="input-round text-xs">
                    <textarea v-model="form.note" placeholder="å‚™è¨»å…§å®¹" class="input-round text-xs" rows="2"></textarea>
                    <div class="flex gap-2">
                        <select v-model="form.transport" class="input-round"><option value="walk">ğŸš¶ èµ°è·¯</option><option value="car">ğŸš— æ±½è»Š</option><option value="bus">ğŸšŒ å…¬è»Š</option></select>
                        <div class="flex-1 flex gap-1">
                            <input v-model="form.travelTime" class="flex-1 input-round">
                            <select v-model="form.travelUnit" class="w-16 input-round text-xs"><option value="m">min</option><option value="h">hour</option></select>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 mt-8">
                    <button @click="showModal = false" class="flex-1 py-4 bg-gray-50 rounded-2xl font-bold">å–æ¶ˆ</button>
                    <button @click="saveForm" class="flex-[2] py-4 teal-theme text-white rounded-2xl font-black">å„²å­˜è¡Œç¨‹</button>
                </div>
            </div>
        </div>

        <div v-if="showMemberModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center p-8 z-[60]">
            <div class="bg-white w-full rounded-[40px] p-8 animate-up">
                <h3 class="font-black text-lg mb-4 text-center">ç·¨è¼¯æ—…ä¼´ ğŸ‘¥</h3>
                <p class="text-[10px] text-gray-400 mb-4 text-center">è«‹ç”¨é€—è™Ÿéš”é–‹åå­—ï¼Œä¾‹å¦‚ï¼šBibi, æœ‹å‹</p>
                <input v-model="memberInput" class="input-round font-bold text-center" placeholder="è¼¸å…¥å§“å...">
                <div class="flex gap-3 mt-6">
                    <button @click="showMemberModal = false" class="flex-1 py-3 bg-gray-50 rounded-xl">å–æ¶ˆ</button>
                    <button @click="updateMembers" class="flex-1 py-3 teal-theme text-white rounded-xl font-bold">å„²å­˜</button>
                </div>
            </div>
        </div>

        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/80 backdrop-blur-xl border-t border-gray-100 flex justify-around py-5 rounded-t-[40px] shadow-2xl z-40">
            <button @click="activeTab = 'itinerary'" :class="{'active-tab': activeTab === 'itinerary'}" class="flex flex-col items-center text-gray-300">
                <i class="fas fa-calendar-alt text-xl"></i><span class="text-[9px] mt-1 font-black tracking-widest uppercase">Plan</span>
            </button>
            <button @click="activeTab = 'wallet'" :class="{'active-tab': activeTab === 'wallet'}" class="flex flex-col items-center text-gray-300">
                <i class="fas fa-wallet text-xl"></i><span class="text-[9px] mt-1 font-black tracking-widest uppercase">Wallet</span>
            </button>
            <button @click="activeTab = 'tools'" :class="{'active-tab': activeTab === 'tools'}" class="flex flex-col items-center text-gray-300">
                <i class="fas fa-tools text-xl"></i><span class="text-[9px] mt-1 font-black tracking-widest uppercase">Tool</span>
            </button>
        </nav>
    </div>

    <script>
        const { createApp } = Vue;
        // ğŸ”´ é€™è£¡å·²å¹«å¦³å¡«å…¥æˆªåœ–ä¸­çš„é‡‘é‘°é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyAqfcjA5QuZlDibAJlkJL7IJvj4zwxyjPM",
            authDomain: "busan-trip-bibi.firebaseapp.com",
            databaseURL: "https://busan-trip-bibi-default-rtdb.firebaseio.com",
            projectId: "busan-trip-bibi",
            storageBucket: "busan-trip-bibi.firebasestorage.app",
            messagingSenderId: "396715066973",
            appId: "1:396715066973:web:3e839e086f68e0d47348e3"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        createApp({
            data() {
                return {
                    activeTab: 'itinerary', selectedDay: 1,
                    dateInfo: [{date:'2/17',week:'ä¸€'},{date:'2/18',week:'äºŒ'},{date:'2/19',week:'ä¸‰'},{date:'2/20',week:'å››'},{date:'2/21',week:'äº”'}],
                    showModal: false, showBillModal: false, showMemberModal: false,
                    isEditing: false, editIndex: null, calcKrw: null, memberInput: '',
                    members: ['Bibi'],
                    form: { time: '09:00', place: '', note: '', transport: 'walk', travelTime: '10', travelUnit: 'm', stayTime: '1', stayUnit: 'h', mapUrl: '' },
                    billForm: { itemName: '', store: '', amount: '', category: 'food', payer: 'Bibi', method: 'card' },
                    bills: [],
                    itinerary: { 1: [], 2: [], 3: [], 4: [], 5: [] }
                }
            },
            computed: {
                totalSpent() { return this.bills.reduce((sum, b) => sum + Number(b.amount), 0); }
            },
            mounted() {
                db.ref('busan_v3_data').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        this.itinerary = data.itinerary || { 1: [], 2: [], 3: [], 4: [], 5: [] };
                        this.bills = data.bills || [];
                        this.members = data.members || ['Bibi'];
                    }
                });
            },
            methods: {
                sync() { db.ref('busan_v3_data').set({ itinerary: this.itinerary, bills: this.bills, members: this.members }); },
                getMemberTotal(name) { return this.bills.filter(b => b.payer === name).reduce((sum, b) => sum + Number(b.amount), 0); },
                manageMembers() { this.memberInput = this.members.join(', '); this.showMemberModal = true; },
                updateMembers() { this.members = this.memberInput.split(',').map(s => s.trim()).filter(s => s); this.sync(); this.showMemberModal = false; },
                getTransportIcon(t) { return t === 'walk' ? 'fas fa-walking' : (t === 'car' ? 'fas fa-car' : 'fas fa-bus'); },
                getCategoryIcon(c) { return { food: 'fas fa-utensils', shop: 'fas fa-shopping-bag' }[c] || 'fas fa-tag'; },
                openAddModal() { this.isEditing = false; this.form = { time: '09:00', place: '', note: '', transport: 'walk', travelTime: '10', travelUnit: 'm', stayTime: '1', stayUnit: 'h', mapUrl: '' }; this.showModal = true; },
                openEditModal(idx) { this.isEditing = true; this.editIndex = idx; this.form = { ...this.itinerary[this.selectedDay][idx] }; this.showModal = true; },
                saveForm() {
                    if(!this.form.place) return;
                    if(this.isEditing) this.itinerary[this.selectedDay][this.editIndex] = { ...this.form };
                    else this.itinerary[this.selectedDay].push({ ...this.form });
                    this.itinerary[this.selectedDay].sort((a, b) => a.time.localeCompare(b.time));
                    this.sync(); this.showModal = false;
                },
                deleteItem(idx) { if(confirm('åˆªé™¤è¡Œç¨‹ï¼Ÿ')) { this.itinerary[this.selectedDay].splice(idx, 1); this.sync(); } },
                openBillModal() { this.billForm = { itemName: '', store: '', amount: '', category: 'food', payer: this.members[0], method: 'card' }; this.showBillModal = true; },
                saveBill() { if(!this.billForm.amount) return; this.bills.unshift({ ...this.billForm }); this.sync(); this.showBillModal = false; },
                exportToImg() {
                    const el = document.getElementById('capture-area');
                    html2canvas(el, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `Busan_Day${this.selectedDay}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    });
                }
            }
        }).mount('#app')
    </script>
</body>
</html>

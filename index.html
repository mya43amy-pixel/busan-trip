<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>busan</title>
    <meta name="apple-mobile-web-app-title" content="busan">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="icon.png">
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuedraggable@4.1.0/dist/vuedraggable.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: #f8fbfb; -webkit-tap-highlight-color: transparent; letter-spacing: 0.01em; }
        .teal-theme { background-color: #78B7BB; }
        .teal-text { color: #78B7BB; }
        .active-tab { color: #78B7BB !important; font-weight: bold; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .input-round { border-radius: 12px; border: 1px solid #eef2f2; padding: 12px; outline: none; background: #f9fbfb; width: 100%; font-size: 14px; }
        .card-pop { border-radius: 20px; background: white; box-shadow: 0 4px 12px rgba(120, 183, 187, 0.08); }
        .card-bought { opacity: 0.6; filter: grayscale(0.5); }
        [v-cloak] { display: none; }
        .summary-box { background-color: #F0F7F7; border: 1px solid #E2EEEE; }
        .date-btn-text { font-size: 15px; font-weight: 800; }
        .memo-item { background: white; border-radius: 18px; padding: 15px; border: 1px solid #f0f4f4; margin-bottom: 10px; }
        .chart-container { position: relative; height: 180px; width: 100%; }
        /* åŒ¯å‡ºæ¨¡å¼æ¨£å¼ */
        .export-mode #header-area { border-radius: 0; }
        .export-mode nav, .export-mode .export-btn, .export-mode button, .export-mode .fixed { display: none !important; }
        /* åˆ‡æ›é–‹é—œæ¨£å¼ */
        .type-toggle { display: flex; background: #f1f5f5; border-radius: 12px; padding: 4px; gap: 4px; }
        .type-toggle button { flex: 1; padding: 8px; border-radius: 10px; font-size: 12px; font-weight: bold; transition: 0.3s; }
        .type-toggle .active-income { background: #78B7BB; color: white; }
        .type-toggle .active-expense { background: #F87171; color: white; }
        /* ç¦æ­¢é•·æŒ‰é¸å–®ä»¥ä¾¿æ‹–æ‹½ */
        .bill-card, .itinerary-card { -webkit-touch-callout: none !important; -webkit-user-select: none !important; user-select: none !important; }
    </style>
</head>
<body>
    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen pb-28 relative bg-[#f8fbfb] shadow-2xl">
        <header id="header-area" class="teal-theme pt-6 pb-4 px-4 text-white rounded-b-[35px] shadow-lg">
            <h1 class="text-center text-base font-black tracking-[0.3em] mb-4">2026 busan</h1>
            <div class="flex justify-center items-center gap-2 overflow-x-auto no-scrollbar px-1">
                <div v-for="(d, i) in dateConfig" :key="i" @click="selectedDay = (i+1)"
                    :class="selectedDay === (i+1) ? 'bg-white text-[#78B7BB] shadow-md' : 'bg-white/20 text-white'"
                    class="min-w-[65px] h-16 rounded-[20px] flex flex-col items-center justify-center cursor-pointer transition-all">
                    <span class="date-btn-text">{{d.date.split('/')[1]}}</span>
                    <span class="date-btn-text">{{d.day}}</span>
                </div>
            </div>
        </header>

        <main class="p-5">
            <div v-if="activeTab === 'itinerary'" class="space-y-6">
                <div @click="openSummaryModal" class="summary-box w-full py-4 px-6 rounded-2xl text-center cursor-pointer">
                    <p class="teal-text font-bold text-sm tracking-widest uppercase">{{ dailySummaries[selectedDay] || 'é»æ“Šç·¨è¼¯ä»Šæ—¥å¤§ç¶±...' }}</p>
                </div>
                
                <div v-for="(item, index) in (itinerary[selectedDay] || [])" :key="index">
                    <div v-if="item.transitTime" class="flex items-center gap-2 ml-8 mb-2 text-[13px] text-gray-400 font-bold">
                        <span class="flex gap-1">
                            <i v-for="t in getTransitArray(item.transitType)" :key="t" :class="getTransitIcon(t)"></i>
                        </span>
                        <span>{{item.transitTime}}{{item.transitUnit}}</span>
                    </div>
                    <div @click="openEditModal(index)" class="p-5 card-pop border border-gray-50 flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2.5">
                                <span class="text-[12px] font-black px-2.5 py-1 bg-teal-50 teal-text rounded-md">{{item.time}}</span>
                                <a v-if="item.mapUrl" :href="item.mapUrl" target="_blank" @click.stop class="w-7 h-7 flex items-center justify-center bg-gray-100 rounded-full text-xs teal-text">
                                    <i class="fas fa-link"></i>
                                </a>
                            </div>
                            <h3 class="font-bold text-lg mt-2.5 text-gray-800">{{item.place}}</h3>
                            <p class="text-[13px] text-gray-400 mt-1.5 whitespace-pre-wrap">{{item.note}}</p>
                        </div>
                        <div v-if="item.stayTime" class="text-right">
                            <div class="text-[10px] bg-gray-50 px-2 py-1 rounded-md text-gray-400 font-bold">
                                <i class="far fa-clock mr-1"></i>åœç•™ {{item.stayTime}}{{item.stayUnit}}
                            </div>
                        </div>
                    </div>
                </div>

                <button @click="openAddModal" class="w-full py-4 border-2 border-dashed border-teal-100 rounded-[24px] text-teal-200 font-bold">+ æ–°å¢è¡Œç¨‹</button>
                <div class="text-center pt-8">
                    <button @click="exportImage" class="export-btn text-[10px] text-gray-300 font-bold tracking-widest uppercase opacity-50">
                        <i class="fas fa-download mr-1"></i>åŒ¯å‡ºä»Šæ—¥è¡Œç¨‹åœ–ç‰‡
                    </button>
                </div>
            </div>

            <div v-if="activeTab === 'wallet'" class="space-y-6">
                <div class="bg-gradient-to-br from-[#78B7BB] to-[#95d1d5] p-6 rounded-[30px] text-white shadow-xl text-center">
                    <p class="text-[10px] opacity-80 font-bold uppercase tracking-widest">Total Spent</p>
                    <h2 class="text-4xl font-black">â‚© {{totalSpent.toLocaleString()}}</h2>
                    <p class="text-sm opacity-70 font-bold mb-4"> â‰ˆ NT$ {{Math.round(totalSpent * rate).toLocaleString()}}</p>
                    <div class="bg-white/10 rounded-2xl p-3 mb-4 text-xs font-bold">ç¾é‡‘é¤˜é¡: â‚© {{balance.toLocaleString()}}</div>
                    
                    <div class="grid grid-cols-2 gap-2 border-t border-white/20 pt-4">
                        <div v-for="member in members" :key="member" class="bg-white/5 p-2 rounded-xl border border-white/10">
                            <p class="text-[10px] opacity-70 truncate">{{member}}</p>
                            <p class="text-xs font-bold">â‚© {{getMemberTotal(member).toLocaleString()}}</p>
                            <p class="text-[9px] opacity-50 font-medium">NT$ {{Math.round(getMemberTotal(member) * rate).toLocaleString()}}</p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center px-2">
                    <span class="text-[10px] text-gray-400 font-bold">
                        <i class="fas fa-sync-alt mr-1"></i>å³æ™‚åŒ¯ç‡: 1 éŸ“å…ƒ = {{rate}} å°å¹£
                    </span>
                    <button @click="manageMembers" class="text-[10px] teal-text font-bold">
                        <i class="fas fa-users-cog mr-1"></i>æ—…ä¼´æˆå“¡
                    </button>
                </div>

                <draggable v-model="bills" item-key="id" :delay="500" :touch-start-threshold="10" @end="sync" class="space-y-3">
                    <template #item="{element, index}">
                        <div @click="editBill(index)" class="bill-card bg-white p-4 rounded-2xl border border-gray-50 shadow-sm flex justify-between items-center cursor-pointer active:scale-[0.98] transition-all">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center" :class="element.type === 'income' ? 'bg-orange-50 text-orange-400' : 'bg-teal-50 teal-text'">
                                    <i :class="element.type === 'income' ? 'fas fa-hand-holding-usd' : (element.method === 'ç¾é‡‘' ? 'fas fa-coins' : 'fas fa-credit-card')"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-800 text-sm">{{element.itemName}}</p>
                                    <p class="text-[10px] text-gray-400 font-bold uppercase">{{element.payer}} Â· {{element.type === 'income' ? 'æ”¶å…¥' : element.category}}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-black text-sm" :class="element.type === 'income' ? 'text-orange-500' : 'text-gray-700'">
                                    {{element.type === 'income' ? '+' : '-'}} â‚© {{element.amount.toLocaleString()}}
                                </p>
                                <p class="text-[9px] text-gray-300">NT$ {{Math.round(element.amount * rate).toLocaleString()}}</p>
                            </div>
                        </div>
                    </template>
                </draggable>

                <div class="card-pop p-6 mt-8">
                    <h3 class="text-sm font-black text-gray-700 mb-6 text-center uppercase tracking-widest">æ¶ˆè²»ä½”æ¯”åˆ†æ</h3>
                    <div class="chart-container mb-6"><canvas id="expenseChart"></canvas></div>
                    <div class="space-y-2">
                        <div v-for="stat in categoryStats" :key="stat.name" class="flex justify-between items-center text-xs border-b border-gray-50 pb-2">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full" :style="{backgroundColor: stat.color}"></span>
                                <span class="font-bold text-gray-600">{{stat.name}}</span>
                            </div>
                            <div class="text-right">
                                <span class="font-black text-gray-800">â‚© {{stat.amount.toLocaleString()}}</span>
                                <span class="ml-2 text-gray-400">({{stat.percent}}%)</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button @click="openBillModal" class="fixed bottom-28 right-6 w-16 h-16 teal-theme text-white rounded-full shadow-2xl flex items-center justify-center text-2xl border-4 border-white z-50">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <div v-if="activeTab === 'tools'" class="space-y-8">
                <div class="card-pop p-4 space-y-3">
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl">
                        <span class="text-xs font-bold text-gray-400">KRW</span>
                        <input type="number" v-model="convKRW" @input="updateConv('KRW')" class="text-right bg-transparent outline-none font-bold flex-1 px-2">
                    </div>
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl">
                        <span class="text-xs font-bold text-gray-400">TWD</span>
                        <input type="number" v-model="convTWD" @input="updateConv('TWD')" class="text-right bg-transparent outline-none font-bold teal-text flex-1 px-2">
                    </div>
                </div>

                <div v-for="cat in ['é£Ÿç‰©', 'è³¼ç‰©', 'ç¾å¦', 'å…¶ä»–']" :key="cat" class="space-y-3">
                    <div @click="collapsed[cat] = !collapsed[cat]" class="flex justify-between items-center px-2 cursor-pointer">
                        <h3 class="font-black text-gray-700 text-sm">{{cat}} ({{getCatItems(cat).length}})</h3>
                        <i class="fas fa-chevron-down text-[10px] text-gray-300 transition-transform" :class="{'rotate-180': !collapsed[cat]}"></i>
                    </div>
                    <div v-show="!collapsed[cat]" class="grid grid-cols-2 gap-3">
                        <div v-for="element in getCatItems(cat)" :key="element.id" 
                             class="card-pop overflow-hidden border border-gray-50 relative flex flex-col" 
                             :class="{'card-bought': element.isBought}">
                            <div @click="editShopItem(element.id)" class="aspect-square bg-gray-50 flex items-center justify-center overflow-hidden">
                                <img v-if="element.imgBase64" :src="element.imgBase64" class="w-full h-full object-cover">
                                <i v-else class="fas fa-shopping-bag text-gray-200 text-2xl"></i>
                            </div>
                            <div class="p-3">
                                <h4 class="font-bold text-gray-800 text-xs truncate">{{element.name}}</h4>
                                <p v-if="element.price > 0" class="teal-text font-black text-xs">â‚© {{element.price.toLocaleString()}}</p>
                            </div>
                            <button @click.stop="toggleBought(element.id)" 
                                    class="absolute top-2 right-2 w-7 h-7 rounded-full flex items-center justify-center shadow-md bg-white/90" 
                                    :class="element.isBought ? 'teal-theme text-white' : 'text-gray-300'">
                                <i class="fas fa-check text-[10px]"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <button @click="openShopModal" class="w-full py-4 border-2 border-dashed border-teal-100 rounded-[24px] text-teal-200 font-bold">+ æ–°å¢å¾…è²·</button>

                <div class="pt-6 border-t border-gray-100">
                    <h3 class="font-black text-gray-700 text-sm px-2 mb-4 uppercase tracking-widest">Memo / Links</h3>
                    <div v-for="(memo, index) in travelNotes" :key="index" class="memo-item shadow-sm flex items-start gap-3 relative">
                        <div @click="openNoteEdit(index)" class="flex-1">
                            <p class="text-sm text-gray-600 font-medium whitespace-pre-wrap">{{memo.content}}</p>
                            <a v-if="memo.tag" :href="memo.tag" target="_blank" @click.stop class="text-teal-500 text-[10px] break-all block mt-2 underline">é€£çµç›´é”</a>
                        </div>
                        <button @click="deleteNote(index)" class="text-gray-200 text-xs"><i class="fas fa-times"></i></button>
                    </div>
                    <button @click="openNoteAdd" class="w-full py-4 bg-teal-50 text-teal-600 rounded-[24px] font-bold mt-4">+ æ–°å¢ MEMO</button>
                </div>
            </div>
        </main>

        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/95 border-t border-gray-100 flex justify-around py-5 rounded-t-[35px] z-40">
            <button @click="activeTab = 'itinerary'" :class="{'active-tab': activeTab === 'itinerary'}" class="flex flex-col items-center text-gray-300">
                <i class="fas fa-calendar-alt text-xl"></i><span class="text-[9px] mt-1 font-black uppercase">Plan</span>
            </button>
            <button @click="activeTab = 'wallet'" :class="{'active-tab': activeTab === 'wallet'}" class="flex flex-col items-center text-gray-300">
                <i class="fas fa-wallet text-xl"></i><span class="text-[9px] mt-1 font-black uppercase">Wallet</span>
            </button>
            <button @click="activeTab = 'tools'" :class="{'active-tab': activeTab === 'tools'}" class="flex flex-col items-center text-gray-300">
                <i class="fas fa-shopping-bag text-xl"></i><span class="text-[9px] mt-1 font-black uppercase">Shop</span>
            </button>
        </nav>

        <div v-if="showModal" class="fixed inset-0 bg-black/60 z-[60] flex items-end" @click.self="showModal = false">
            <div class="bg-white w-full rounded-t-[40px] p-8 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between mb-8"><h3 class="text-xl font-black">è¡Œç¨‹ç´°ç¯€</h3><button @click="showModal = false" class="text-gray-400"><i class="fas fa-times"></i></button></div>
                <div class="space-y-6">
                    <div class="flex gap-4">
                        <div class="flex-1"><label class="block text-xs font-black text-gray-400 mb-2">æ™‚é–“</label><input type="time" v-model="form.time" class="input-round font-bold teal-text text-lg"></div>
                        <div class="flex-1"><label class="block text-xs font-black text-gray-400 mb-2">åœ°é»</label><input v-model="form.place" class="input-round h-[50px]" placeholder="æ™¯é»åç¨±"></div>
                    </div>
                    <div class="bg-gray-50 p-5 rounded-[24px]">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-black text-gray-400 mb-2">äº¤é€šå·¥å…·</label>
                                <div class="flex gap-1 mb-3">
                                    <button v-for="t in ['walk','car','bus','subway','plane']" :key="t" @click="toggleTransit(t)" :class="form.transitType.includes(t) ? 'teal-theme text-white' : 'bg-white text-gray-300'" class="w-8 h-8 rounded-full flex items-center justify-center text-xs shadow-sm"><i :class="getTransitIcon(t)"></i></button>
                                </div>
                                <div class="flex gap-1"><input type="number" v-model="form.transitTime" class="input-round p-2 text-xs w-16 text-center" placeholder="10"><select v-model="form.transitUnit" class="input-round p-2 text-xs"><option value="m">m</option><option value="h">h</option></select></div>
                            </div>
                            <div>
                                <label class="block text-xs font-black text-gray-400 mb-2">é è¨ˆåœç•™</label>
                                <div class="flex gap-1 mt-11"><input type="number" v-model="form.stayTime" class="input-round p-2 text-xs w-16 text-center" placeholder="2"><select v-model="form.stayUnit" class="input-round p-2 text-xs"><option value="m">m</option><option value="h">h</option></select></div>
                            </div>
                        </div>
                    </div>
                    <div><label class="block text-xs font-black text-gray-400 mb-2">åœ°åœ–é€£çµ</label><input v-model="form.mapUrl" class="input-round" placeholder="è²¼ä¸Š Google Map URL"></div>
                    <div><label class="block text-xs font-black text-gray-400 mb-2">å‚™è¨»</label><textarea v-model="form.note" class="input-round h-24" placeholder="è©³ç´°ç­†è¨˜..."></textarea></div>
                    <div class="flex gap-3 pt-4"><button v-if="isEditing" @click="deleteItem" class="flex-1 py-4 bg-red-50 text-red-400 rounded-2xl font-bold">åˆªé™¤</button><button @click="saveForm" class="flex-[2] py-4 teal-theme text-white rounded-2xl font-black">å„²å­˜</button></div>
                </div>
            </div>
        </div>

        <div v-if="showBillModal" class="fixed inset-0 bg-black/60 z-[60] flex items-end" @click.self="showBillModal = false">
            <div class="bg-white w-full rounded-t-[40px] p-8 pb-12 overflow-y-auto max-h-[90vh]">
                <div class="flex justify-between mb-8"><h3 class="text-xl font-black">æ¶ˆè²»è¨˜éŒ„</h3><button @click="showBillModal = false" class="text-gray-400"><i class="fas fa-times"></i></button></div>
                <div class="space-y-4">
                    <div class="type-toggle"><button @click="billForm.type = 'expense'" :class="billForm.type === 'expense' ? 'active-expense' : 'text-gray-400'">æ”¯å‡º</button><button @click="billForm.type = 'income'" :class="billForm.type === 'income' ? 'active-income' : 'text-gray-400'">æ›éŒ¢/æ”¶å…¥</button></div>
                    <div><label class="block text-xs font-black text-gray-400 mb-2">é‡‘é¡ (KRW)</label><input type="number" v-model="billForm.amount" class="input-round font-black text-xl teal-text"></div>
                    <div><label class="block text-xs font-black text-gray-400 mb-2">å“é …åç¨±</label><input v-model="billForm.itemName" class="input-round" placeholder="ä¾‹å¦‚ï¼šåˆé¤ç‡’è‚‰"></div>
                    <div class="grid grid-cols-2 gap-3" v-if="billForm.type === 'expense'"><select v-model="billForm.method" class="input-round text-xs font-bold"><option value="ç¾é‡‘">ä½¿ç”¨ ç¾é‡‘</option><option value="åˆ·å¡">ä½¿ç”¨ åˆ·å¡</option></select><select v-model="billForm.category" class="input-round text-xs font-bold"><option v-for="c in ['é£Ÿç‰©', 'è³¼ç‰©', 'ç¾å¦', 'äº¤é€š', 'å…¶ä»–']" :key="c" :value="c">{{c}}</option></select></div>
                    <select v-model="billForm.payer" class="input-round text-xs font-bold"><option v-for="m in members" :key="m" :value="m">{{m}} ä»˜æ¬¾</option></select>
                    <div class="flex gap-4 mt-8"><button v-if="isEditBill" @click="deleteBill" class="flex-1 py-4 bg-red-50 text-red-400 rounded-2xl font-bold">åˆªé™¤</button><button @click="saveBill" class="flex-[2] py-4 teal-theme text-white rounded-2xl font-black">å„²å­˜é …ç›®</button></div>
                </div>
            </div>
        </div>

        <div v-if="showShopModal" class="fixed inset-0 bg-black/60 z-[60] flex items-end" @click.self="showShopModal = false">
            <div class="bg-white w-full rounded-t-[40px] p-8 pb-12 overflow-y-auto max-h-[90vh]">
                <div class="flex justify-between mb-8"><h3 class="text-xl font-black">å¾…è²·æ¸…å–®</h3><button @click="showShopModal = false" class="text-gray-400"><i class="fas fa-times"></i></button></div>
                <div class="space-y-4">
                    <div class="flex justify-center">
                        <label class="w-24 h-24 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-100 flex items-center justify-center cursor-pointer overflow-hidden relative">
                            <img v-if="shopForm.imgBase64" :src="shopForm.imgBase64" class="w-full h-full object-cover">
                            <i v-else class="fas fa-camera text-gray-200"></i>
                            <input type="file" @change="handleFileUpload" class="hidden" accept="image/*">
                        </label>
                    </div>
                    <input v-model="shopForm.name" placeholder="å•†å“åç¨±" class="input-round font-bold">
                    <input v-model="shopForm.price" type="number" class="input-round teal-text font-black" placeholder="é ä¼°åƒ¹æ ¼ KRW">
                    <select v-model="shopForm.category" class="input-round text-xs font-bold"><option v-for="c in ['é£Ÿç‰©', 'è³¼ç‰©', 'ç¾å¦', 'å…¶ä»–']" :key="c" :value="c">{{c}}</option></select>
                    <textarea v-model="shopForm.note" class="input-round h-20 text-xs" placeholder="å‚™è¨»..."></textarea>
                    <div class="flex gap-4 mt-8"><button v-if="isEditShop" @click="deleteShopItem" class="flex-1 py-4 bg-red-50 text-red-400 rounded-2xl font-bold">åˆªé™¤</button><button @click="saveShopItem" class="flex-[2] py-4 teal-theme text-white rounded-2xl font-black">å„²å­˜å•†å“</button></div>
                </div>
            </div>
        </div>

        <div v-if="showNoteModal" class="fixed inset-0 bg-black/60 z-[60] flex items-end" @click.self="showNoteModal = false">
            <div class="bg-white w-full rounded-t-[40px] p-8 pb-12">
                <h3 class="font-black mb-6 text-lg">ç·¨è¼¯ç­†è¨˜</h3>
                <textarea v-model="noteForm.content" class="input-round text-sm mb-4" rows="6" placeholder="è¼¸å…¥å…§å®¹..."></textarea>
                <input v-model="noteForm.tag" class="input-round text-xs mb-4" placeholder="é€£çµ URL (é¸å¡«)">
                <div class="flex gap-4"><button @click="showNoteModal = false" class="flex-1 py-4 bg-gray-100 rounded-2xl font-bold text-gray-400">å–æ¶ˆ</button><button @click="saveNote" class="flex-[2] py-4 teal-theme text-white rounded-2xl font-black">å„²å­˜ç­†è¨˜</button></div>
            </div>
        </div>

        <div v-if="showMemberModal" class="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-6">
            <div class="bg-white w-full rounded-[35px] p-8 shadow-2xl">
                <h3 class="font-black mb-6 text-center text-gray-800">ç·¨è¼¯æˆå“¡ ğŸ‘¥</h3>
                <input v-model="memberInput" class="input-round text-center mb-4" placeholder="æˆå“¡åç¨±ï¼Œç”¨é€—è™Ÿéš”é–‹">
                <div class="flex gap-3"><button @click="showMemberModal = false" class="flex-1 py-4 bg-gray-50 text-gray-400 rounded-2xl font-bold text-xs">å–æ¶ˆ</button><button @click="updateMembers" class="flex-1 py-4 teal-theme text-white rounded-2xl font-black text-xs">æ›´æ–°åå–®</button></div>
            </div>
        </div>

        <div v-if="showSummaryModal" class="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-6">
            <div class="bg-white w-full rounded-[35px] p-8 shadow-2xl">
                <h3 class="text-lg font-black text-center mb-6">ä»Šæ—¥å¤§ç¶±</h3>
                <input v-model="tempSummary" class="input-round text-center font-bold" placeholder="ä¾‹å¦‚ï¼šæµ·é›²å°ä¸€æ—¥éŠ">
                <div class="flex gap-3 mt-8"><button @click="showSummaryModal = false" class="flex-1 py-4 bg-gray-50 text-gray-400 rounded-2xl font-bold text-xs">å–æ¶ˆ</button><button @click="saveSummary" class="flex-1 py-4 teal-theme text-white rounded-2xl font-black text-xs">å„²å­˜</button></div>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue;
        // Firebase è¨­å®š
        const firebaseConfig = { apiKey: "AIzaSyAqfcjA5QuZlDibAJlkJL7IJvj4zwxyjPM", authDomain: "busan-trip-bibi.firebaseapp.com", databaseURL: "https://busan-trip-bibi-default-rtdb.firebaseio.com", projectId: "busan-trip-bibi" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const DATA_PATH = 'busan_trip_final';

        createApp({
            components: { draggable: window.vuedraggable },
            data() {
                return {
                    activeTab: 'itinerary', selectedDay: 1, chart: null, rate: 0.024,
                    showModal: false, showBillModal: false, showShopModal: false, showSummaryModal: false, showMemberModal: false, showNoteModal: false,
                    isEditing: false, isEditBill: false, isEditShop: false, isEditNote: false, editIndex: null, tempSummary: '', memberInput: '',
                    members: ['Bibi'], collapsed: { 'é£Ÿç‰©': true, 'è³¼ç‰©': true, 'ç¾å¦': true, 'å…¶ä»–': true },
                    dateConfig: [{date: '2/17', day: 'äºŒ'}, {date: '2/18', day: 'ä¸‰'}, {date: '2/19', day: 'å››'}, {date: '2/20', day: 'äº”'}, {date: '2/21', day: 'å…­'}],
                    form: { time: '09:00', place: '', note: '', transitType: '', transitTime: '', transitUnit: 'm', stayTime: '', stayUnit: 'h', mapUrl: '' },
                    billForm: { itemName: '', amount: '', method: 'ç¾é‡‘', payer: 'Bibi', category: 'é£Ÿç‰©', type: 'expense' },
                    shopForm: { name: '', price: 0, category: 'è³¼ç‰©', imgBase64: '', isBought: false, note: '', id: null },
                    noteForm: { content: '', tag: '' },
                    itinerary: {1:[], 2:[], 3:[], 4:[], 5:[]}, bills: [], shoppingList: [], dailySummaries: {1:'', 2:'', 3:'', 4:'', 5:''}, travelNotes: [],
                    convKRW: null, convTWD: null
                }
            },
            computed: {
                totalSpent() { return (this.bills || []).filter(b => b.type !== 'income').reduce((sum, b) => sum + (Number(b.amount) || 0), 0); },
                totalIncome() { return (this.bills || []).filter(b => b.type === 'income').reduce((sum, b) => sum + (Number(b.amount) || 0), 0); },
                totalCash() { return (this.bills || []).filter(b => b.type === 'expense' && b.method === 'ç¾é‡‘').reduce((sum, b) => sum + (Number(b.amount) || 0), 0); },
                balance() { return this.totalIncome - this.totalCash; },
                categoryStats() {
                    const cats = ['é£Ÿç‰©', 'è³¼ç‰©', 'ç¾å¦', 'äº¤é€š', 'å…¶ä»–'];
                    const expensesOnly = (this.bills || []).filter(b => b.type === 'expense');
                    const total = expensesOnly.reduce((sum, b) => sum + Number(b.amount), 0) || 1;
                    return cats.map((name, i) => {
                        const amount = expensesOnly.filter(b => b.category === name).reduce((sum, b) => sum + Number(b.amount), 0);
                        return { name, amount, color: ['#A3D2D5', '#B8E1DD', '#D1EDE9', '#E6F5F3', '#F2FAF9'][i], percent: Math.round((amount / total) * 100) };
                    });
                }
            },
            watch: { 
                activeTab(newVal) { if (newVal === 'wallet') { this.$nextTick(() => this.initChart()); } } 
            },
            mounted() {
                this.fetchRate(); // ğŸš€ åˆå§‹åŒ–æŠ“å–å³æ™‚åŒ¯ç‡
                db.ref(DATA_PATH).on('value', (s) => {
                    const data = s.val();
                    if (data) {
                        this.itinerary = data.itinerary || {1:[], 2:[], 3:[], 4:[], 5:[]};
                        this.bills = data.bills || [];
                        this.shoppingList = data.shoppingList || [];
                        this.dailySummaries = data.dailySummaries || {1:'', 2:'', 3:'', 4:'', 5:''};
                        this.members = data.members || ['Bibi'];
                        this.travelNotes = data.travelNotes || [];
                        if (this.activeTab === 'wallet') this.initChart();
                    }
                });
            },
            methods: {
                async fetchRate() {
                    try {
                        const response = await fetch('https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/krw.json');
                        const data = await response.json();
                        this.rate = parseFloat(data.krw.twd.toFixed(5));
                    } catch (e) {
                        console.error("åŒ¯ç‡æŠ“å–å¤±æ•—", e);
                        this.rate = 0.024; // å¤±æ•—æ™‚ä¿åº•
                    }
                },
                sync() { 
                    db.ref(DATA_PATH).set({ 
                        itinerary: this.itinerary, bills: this.bills, shoppingList: this.shoppingList, 
                        dailySummaries: this.dailySummaries, members: this.members, travelNotes: this.travelNotes 
                    }); 
                },
                initChart() {
                    const ctx = document.getElementById('expenseChart'); 
                    if (!ctx) return; 
                    if (this.chart) this.chart.destroy();
                    this.chart = new Chart(ctx, { 
                        type: 'doughnut', 
                        data: { 
                            labels: this.categoryStats.map(s => s.name), 
                            datasets: [{ data: this.categoryStats.map(s => s.amount), backgroundColor: this.categoryStats.map(s => s.color), borderWidth: 0 }] 
                        }, 
                        options: { cutout: '70%', plugins: { legend: { display: false } }, maintainAspectRatio: false } 
                    });
                },
                updateConv(type) { 
                    if(type === 'KRW') this.convTWD = this.convKRW ? Math.round(this.convKRW * this.rate) : null; 
                    else this.convKRW = this.convTWD ? Math.round(this.convTWD / this.rate) : null; 
                },
                getCatItems(c) { return (this.shoppingList || []).filter(i => i.category === c); },
                getTransitIcon(t) { return {walk:'fas fa-walking', car:'fas fa-taxi', bus:'fas fa-bus', plane:'fas fa-plane', subway:'fas fa-subway'}[t]; },
                getTransitArray(t) { return t ? t.split(',') : []; },
                toggleTransit(t) { 
                    let arr = this.getTransitArray(this.form.transitType); 
                    if(arr.includes(t)) arr = arr.filter(i => i !== t); else arr.push(t); 
                    this.form.transitType = arr.join(','); 
                },
                getMemberTotal(m) { return (this.bills || []).filter(b => b.payer === m && b.type === 'expense').reduce((sum, b) => sum + (Number(b.amount) || 0), 0); },
                
                // è¡Œç¨‹æ–¹æ³•
                openAddModal() { this.isEditing = false; this.form = { time: '09:00', place: '', note: '', transitType: '', transitTime: '', transitUnit: 'm', stayTime: '', stayUnit: 'h', mapUrl: '' }; this.showModal = true; },
                openEditModal(idx) { this.isEditing = true; this.editIndex = idx; this.form = {...this.itinerary[this.selectedDay][idx]}; this.showModal = true; },
                saveForm() { 
                    if(this.isEditing) this.itinerary[this.selectedDay][this.editIndex] = {...this.form}; 
                    else this.itinerary[this.selectedDay].push({...this.form}); 
                    this.itinerary[this.selectedDay].sort((a,b) => a.time.localeCompare(b.time)); 
                    this.sync(); this.showModal = false; 
                },
                deleteItem() { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { this.itinerary[this.selectedDay].splice(this.editIndex, 1); this.sync(); this.showModal = false; } },
                
                // è¨˜å¸³æ–¹æ³•
                openBillModal() { this.isEditBill = false; this.billForm = { itemName: '', amount: '', method: 'ç¾é‡‘', payer: this.members[0], category: 'é£Ÿç‰©', type: 'expense' }; this.showBillModal = true; },
                editBill(idx) { this.isEditBill = true; this.editIndex = idx; this.billForm = {...this.bills[idx]}; this.showBillModal = true; },
                saveBill() { if(this.isEditBill) this.bills[this.editIndex] = {...this.billForm}; else this.bills.push({...this.billForm}); this.sync(); this.showBillModal = false; },
                deleteBill() { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { this.bills.splice(this.editIndex, 1); this.sync(); this.showBillModal = false; } },
                
                // è³¼ç‰©èˆ‡ç­†è¨˜æ–¹æ³•
                openShopModal() { this.isEditShop = false; this.shopForm = { name: '', price: 0, category: 'è³¼ç‰©', imgBase64: '', isBought: false, note: '', id: Date.now() }; this.showShopModal = true; },
                editShopItem(id) { this.isEditShop = true; this.editIndex = this.shoppingList.findIndex(i => i.id === id); this.shopForm = {...this.shoppingList[this.editIndex]}; this.showShopModal = true; },
                saveShopItem() { if(this.isEditShop) this.shoppingList[this.editIndex] = {...this.shopForm}; else this.shoppingList.push({...this.shopForm}); this.sync(); this.showShopModal = false; },
                deleteShopItem() { if(confirm('ç¢ºå®šåˆªé™¤å•†å“ï¼Ÿ')) { this.shoppingList.splice(this.editIndex, 1); this.sync(); this.showShopModal = false; } },
                toggleBought(id) { const idx = this.shoppingList.findIndex(i => i.id === id); if(idx > -1) { this.shoppingList[idx].isBought = !this.shoppingList[idx].isBought; this.sync(); } },
                handleFileUpload(e) { const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (f) => { this.shopForm.imgBase64 = f.target.result; }; reader.readAsDataURL(file); },
                
                openNoteAdd() { this.isEditNote = false; this.noteForm = { content: '', tag: '' }; this.showNoteModal = true; },
                openNoteEdit(idx) { this.isEditNote = true; this.editIndex = idx; this.noteForm = {...this.travelNotes[idx]}; this.showNoteModal = true; },
                saveNote() { if(this.isEditNote) this.travelNotes[this.editIndex] = {...this.noteForm}; else this.travelNotes.unshift({...this.noteForm}); this.sync(); this.showNoteModal = false; },
                deleteNote(idx) { if(confirm('åˆªé™¤ MEMOï¼Ÿ')) { this.travelNotes.splice(idx, 1); this.sync(); } },
                
                // å…¶ä»–è¨­å®š
                manageMembers() { this.memberInput = this.members.join(', '); this.showMemberModal = true; },
                updateMembers() { this.members = this.memberInput.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s); this.sync(); this.showMemberModal = false; },
                openSummaryModal() { this.tempSummary = this.dailySummaries[this.selectedDay] || ''; this.showSummaryModal = true; },
                saveSummary() { this.dailySummaries[this.selectedDay] = this.tempSummary; this.sync(); this.showSummaryModal = false; },
                exportImage() {
                    const appElement = document.getElementById('app'); appElement.classList.add('export-mode');
                    html2canvas(appElement, { useCORS: true, backgroundColor: "#f8fbfb", scale: 2, width: 375 }).then(canvas => {
                        const link = document.createElement('a'); link.download = `Busan_Day${this.selectedDay}.png`;
                        link.href = canvas.toDataURL('image/png'); link.click(); appElement.classList.remove('export-mode');
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>

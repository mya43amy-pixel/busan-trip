<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Busan Trip - Bibi</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'PingFang TC', sans-serif; background-color: #f8fbfb; -webkit-tap-highlight-color: transparent; }
        .teal-theme { background-color: #78B7BB; }
        .teal-text { color: #78B7BB; }
        .active-tab { color: #78B7BB !important; font-weight: bold; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .input-round { border-radius: 14px; border: 1px solid #eef2f2; padding: 12px; outline: none; background: #f9fbfb; width: 100%; font-size: 14px; }
        .card-pop { border-radius: 20px; background: white; box-shadow: 0 4px 12px rgba(120, 183, 187, 0.08); }
        [v-cloak] { display: none; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>
</head>
<body>
    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen pb-28 relative bg-white shadow-2xl overflow-hidden">
        
        <header class="teal-theme pt-12 pb-8 px-4 text-white rounded-b-[40px] shadow-lg">
            <h1 class="text-center text-xl font-bold tracking-widest mb-6">BUSAN 2026 âš“ï¸</h1>
            <div class="flex justify-center items-center gap-3 overflow-x-auto no-scrollbar px-2">
                <div v-for="n in 5" :key="n" @click="selectedDay = n" :class="selectedDay === n ? 'bg-white text-[#78B7BB]' : 'bg-white/20 text-white'" class="min-w-[55px] h-14 rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all shadow-sm">
                    <span class="text-xs font-black">Day {{n}}</span>
                </div>
            </div>
        </header>

        <main class="p-5">
            <div v-if="activeTab === 'itinerary'" class="space-y-4">
                <div v-for="(item, index) in (itinerary[selectedDay] || [])" :key="index" @click="openEditModal(index)" class="p-5 card-pop border border-gray-50 flex justify-between items-center animate-up">
                    <div>
                        <span class="text-[10px] font-bold px-2 py-1 bg-teal-50 teal-text rounded-lg">{{item.time}}</span>
                        <h3 class="font-bold text-gray-800 text-lg mt-1">{{item.place}}</h3>
                        <p class="text-[10px] text-gray-400 mt-1">{{item.note}}</p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-200"></i>
                </div>
                <button @click="openAddModal" class="w-full py-4 border-2 border-dashed border-teal-100 rounded-[24px] text-teal-200 font-bold">+ æ–°å¢è¡Œç¨‹</button>
            </div>

            <div v-if="activeTab === 'wallet'" class="space-y-6">
                <div class="bg-gradient-to-br from-[#78B7BB] to-[#95d1d5] p-6 rounded-[30px] text-white shadow-xl">
                    <div class="text-center mb-4">
                        <p class="text-[10px] opacity-80 font-bold tracking-widest uppercase">Total Spent</p>
                        <h2 class="text-4xl font-black">â‚© {{totalSpent.toLocaleString()}}</h2>
                        <p class="text-sm opacity-70 font-bold">â‰ˆ NT$ {{Math.round(totalSpent * 0.024).toLocaleString()}}</p>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <div class="flex-1 bg-white/10 p-2 rounded-xl text-center">
                            <p class="text-[9px] opacity-70">ğŸ’µ ç¾é‡‘</p>
                            <p class="text-xs font-bold">â‚© {{totalCash.toLocaleString()}}</p>
                        </div>
                        <div class="flex-1 bg-white/10 p-2 rounded-xl text-center">
                            <p class="text-[9px] opacity-70">ğŸ’³ å¡ç‰‡</p>
                            <p class="text-xs font-bold">â‚© {{totalCard.toLocaleString()}}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 border-t border-white/20 pt-4">
                        <div v-for="member in members" :key="member" class="bg-white/5 p-2 rounded-xl border border-white/10">
                            <p class="text-[10px] opacity-70 truncate">{{member}}</p>
                            <p class="text-xs font-bold">â‚© {{getMemberTotal(member).toLocaleString()}}</p>
                            <p class="text-[9px] opacity-50 font-bold">NT$ {{Math.round(getMemberTotal(member) * 0.024).toLocaleString()}}</p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end px-2"><button @click="manageMembers" class="text-[10px] teal-text font-bold"><i class="fas fa-users-cog mr-1"></i>ç·¨è¼¯æ—…ä¼´</button></div>
                <div class="space-y-3">
                    <div v-for="(bill, index) in bills" :key="index" @click="editBill(index)" class="bg-white p-4 rounded-2xl flex justify-between items-center border border-gray-50 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-teal-50 flex items-center justify-center teal-text"><i :class="bill.method === 'cash' ? 'fas fa-coins' : 'fas fa-credit-card'"></i></div>
                            <div><p class="font-bold text-gray-800 text-sm">{{bill.itemName}}</p><p class="text-[10px] text-gray-400 font-bold uppercase">{{bill.payer}}</p></div>
                        </div>
                        <div class="text-right"><p class="font-black text-sm text-gray-700">â‚© {{bill.amount.toLocaleString()}}</p><p class="text-[10px] text-gray-300 font-bold">NT$ {{Math.round(bill.amount * 0.024).toLocaleString()}}</p></div>
                    </div>
                </div>
                <button @click="openBillModal" class="fixed bottom-28 right-6 w-16 h-16 teal-theme text-white rounded-full shadow-2xl flex items-center justify-center text-2xl border-4 border-white z-30"><i class="fas fa-plus"></i></button>
            </div>

            <div v-if="activeTab === 'tools'" class="space-y-6">
                <div class="bg-white p-5 rounded-[25px] shadow-sm border border-gray-50">
                    <p class="text-[10px] teal-text font-bold mb-3 uppercase tracking-widest">Rate Calculator (KRW â†’ TWD)</p>
                    <div class="flex items-center gap-3 bg-gray-50 p-3 rounded-xl">
                        <input type="number" v-model="calcKrw" class="bg-transparent flex-1 font-black text-lg outline-none" placeholder="è¼¸å…¥éŸ“å…ƒ">
                        <span class="text-[10px] text-gray-300 font-bold">KRW</span>
                    </div>
                    <p class="mt-2 px-1 text-xs teal-text font-bold">â‰ˆ NT$ {{Math.round(calcKrw * 0.024).toLocaleString()}}</p>
                </div>

                <div v-for="cat in ['é£Ÿç‰©', 'è³¼ç‰©', 'å…¶ä»–']" :key="cat" class="space-y-3">
                    <div @click="collapsed[cat] = !collapsed[cat]" class="flex justify-between items-center px-2 cursor-pointer">
                        <h3 class="font-black text-gray-700 text-sm">{{cat}} ({{getCatItems(cat).length}})</h3>
                        <i class="fas fa-chevron-down text-xs text-gray-300 transition-transform" :class="{'rotate-180': collapsed[cat]}"></i>
                    </div>
                    <div v-show="!collapsed[cat]" class="grid grid-cols-2 gap-3">
                        <div v-for="(item, idx) in getCatItems(cat)" :key="idx" @click="editShopItem(item.id)" class="card-pop overflow-hidden flex flex-col border border-gray-50 active:scale-95 transition-transform shadow-sm">
                            <div class="aspect-square bg-gray-50 flex items-center justify-center overflow-hidden">
                                <img v-if="item.imgBase64" :src="item.imgBase64" class="w-full h-full object-cover">
                                <i v-else class="fas fa-shopping-bag text-gray-100 text-3xl"></i>
                            </div>
                            <div class="p-3">
                                <h4 class="font-bold text-gray-800 text-xs truncate">{{item.name}}</h4>
                                <p class="teal-text font-black text-xs mt-1">â‚© {{item.price.toLocaleString()}}</p>
                                <p class="text-[9px] text-gray-300 font-bold">NT$ {{Math.round(item.price * 0.024).toLocaleString()}}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="openShopModal" class="w-full py-4 border-2 border-dashed border-teal-100 rounded-[24px] text-teal-200 font-bold">+ æ–°å¢å¾…è²·é …ç›®</button>
            </div>
        </main>

        <div v-if="showModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end z-50">
            <div class="bg-white w-full rounded-t-[40px] p-8 pb-12 animate-up">
                <div class="flex justify-between mb-6"><h3 class="font-black text-lg">è¡Œç¨‹è©³æƒ… ğŸ“</h3><button v-if="isEditing" @click="deleteItem" class="text-red-400 text-xs font-bold underline">åˆªé™¤æ­¤è¡Œç¨‹</button></div>
                <div class="space-y-4">
                    <input v-model="form.place" placeholder="åœ°é»åç¨±" class="input-round font-bold">
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold text-gray-400">æ™‚é–“</span>
                        <input v-model="form.time" type="time" class="input-round font-black flex-1">
                    </div>
                    <textarea v-model="form.note" placeholder="æœ‰ä»€éº¼æƒ³å‚™è¨»çš„å—ï¼Ÿ" class="input-round text-xs" rows="3"></textarea>
                </div>
                <div class="flex gap-4 mt-8"><button @click="showModal = false" class="flex-1 py-4 bg-gray-100 rounded-2xl font-bold">å–æ¶ˆ</button><button @click="saveForm" class="flex-[2] py-4 teal-theme text-white rounded-2xl font-black shadow-lg">å„²å­˜è¡Œç¨‹</button></div>
            </div>
        </div>

        <div v-if="showBillModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end z-50">
            <div class="bg-white w-full rounded-t-[40px] p-8 pb-12 animate-up">
                <div class="flex justify-between mb-6"><h3 class="font-black text-lg">è¨˜å¸³ ğŸ’¸</h3><button v-if="isEditBill" @click="deleteBill" class="text-red-400 text-xs font-bold underline">åˆªé™¤</button></div>
                <div class="space-y-4">
                    <input v-model="billForm.itemName" placeholder="è²·äº†ä»€éº¼ï¼Ÿ" class="input-round font-bold">
                    <div class="flex gap-2">
                        <input v-model.number="billForm.amount" type="number" placeholder="â‚© éŸ“å…ƒé‡‘é¡" class="input-round font-black flex-1">
                        <select v-model="billForm.payer" class="input-round w-28 font-bold"><option v-for="m in members" :key="m" :value="m">{{m}}</option></select>
                    </div>
                    <div class="flex gap-2">
                        <select v-model="billForm.method" class="input-round flex-1 font-bold"><option value="card">ğŸ’³ åˆ·å¡</option><option value="cash">ğŸ’µ ç¾é‡‘</option></select>
                        <textarea v-model="billForm.note" placeholder="å‚™è¨»..." class="input-round flex-[2] text-xs" rows="1"></textarea>
                    </div>
                </div>
                <div class="flex gap-4 mt-8"><button @click="showBillModal = false" class="flex-1 py-4 bg-gray-100 rounded-2xl font-bold">å–æ¶ˆ</button><button @click="saveBill" class="flex-[2] py-4 teal-theme text-white rounded-2xl font-black shadow-lg">å„²å­˜å¸³ç›®</button></div>
            </div>
        </div>

        <div v-if="showMemberModal" class="fixed inset-0 bg-black/60 flex items-center p-8 z-[60]">
            <div class="bg-white w-full rounded-[40px] p-8 animate-up shadow-2xl border border-gray-100">
                <h3 class="font-black text-lg mb-2 text-center">æ—…ä¼´ç®¡ç† ğŸ‘¥</h3>
                <p class="text-[10px] text-gray-400 text-center mb-4">ä½¿ç”¨è‹±æ–‡é€—è™Ÿã€Œ,ã€åˆ†éš”äººå</p>
                <input v-model="memberInput" class="input-round font-bold text-center" placeholder="Bibi, æœ‹å‹A">
                <div class="flex gap-3 mt-6">
                    <button @click="showMemberModal = false" class="flex-1 py-3 bg-gray-50 rounded-xl font-bold">å–æ¶ˆ</button>
                    <button @click="updateMembers" class="flex-1 py-3 teal-theme text-white rounded-xl font-bold shadow-md">å„²å­˜æ—…ä¼´</button>
                </div>
            </div>
        </div>

        <div v-if="showShopModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end z-50">
            <div class="bg-white w-full rounded-t-[40px] p-8 pb-12 animate-up">
                <div class="flex justify-between mb-6"><h3 class="font-black text-lg">å¾…è²·é …ç›® ğŸ›ï¸</h3><button v-if="isEditShop" @click="deleteShopItem" class="text-red-400 text-xs font-bold underline">åˆªé™¤</button></div>
                <div class="space-y-4">
                    <div @click="$refs.fileInput.click()" class="w-full h-32 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-200 flex flex-col items-center justify-center overflow-hidden">
                        <img v-if="shopForm.imgBase64" :src="shopForm.imgBase64" class="w-full h-full object-cover">
                        <div v-else class="text-center"><i class="fas fa-camera text-gray-200 text-2xl mb-1"></i><p class="text-[10px] text-gray-400 font-bold">ä¸Šå‚³ç…§ç‰‡</p></div>
                    </div>
                    <input type="file" ref="fileInput" class="hidden" accept="image/*" @change="handleFileUpload">
                    <div class="flex gap-2">
                        <select v-model="shopForm.category" class="input-round w-28 font-bold"><option value="é£Ÿç‰©">é£Ÿç‰©</option><option value="è³¼ç‰©">è³¼ç‰©</option><option value="å…¶ä»–">å…¶ä»–</option></select>
                        <input v-model="shopForm.name" placeholder="å•†å“åç¨±" class="input-round font-bold flex-1">
                    </div>
                    <input v-model.number="shopForm.price" type="number" placeholder="â‚© éŸ“å…ƒé ä¼°åƒ¹æ ¼" class="input-round font-black">
                </div>
                <div class="flex gap-4 mt-8"><button @click="showShopModal = false" class="flex-1 py-4 bg-gray-100 rounded-2xl font-bold">å–æ¶ˆ</button><button @click="saveShopItem" class="flex-[2] py-4 teal-theme text-white rounded-2xl font-black shadow-lg">å„²å­˜å¾…è²·</button></div>
            </div>
        </div>

        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/95 backdrop-blur-xl border-t border-gray-100 flex justify-around py-5 rounded-t-[35px] z-40 shadow-[0_-4px_20px_rgba(0,0,0,0.03)]">
            <button @click="activeTab = 'itinerary'" :class="{'active-tab': activeTab === 'itinerary'}" class="flex flex-col items-center text-gray-300 transition-colors"><i class="fas fa-calendar-alt text-xl"></i><span class="text-[9px] mt-1 font-black uppercase">Plan</span></button>
            <button @click="activeTab = 'wallet'" :class="{'active-tab': activeTab === 'wallet'}" class="flex flex-col items-center text-gray-300 transition-colors"><i class="fas fa-wallet text-xl"></i><span class="text-[9px] mt-1 font-black uppercase">Wallet</span></button>
            <button @click="activeTab = 'tools'" :class="{'active-tab': activeTab === 'tools'}" class="flex flex-col items-center text-gray-300 transition-colors"><i class="fas fa-shopping-bag text-xl"></i><span class="text-[9px] mt-1 font-black uppercase">Shop</span></button>
        </nav>
    </div>

    <script>
        const { createApp } = Vue;
        const firebaseConfig = {
            apiKey: "AIzaSyAqfcjA5QuZlDibAJlkJL7IJvj4zwxyjPM",
            authDomain: "busan-trip-bibi.firebaseapp.com",
            databaseURL: "https://busan-trip-bibi-default-rtdb.firebaseio.com",
            projectId: "busan-trip-bibi",
            storageBucket: "busan-trip-bibi.firebasestorage.app",
            messagingSenderId: "396715066973",
            appId: "1:396715066973:web:3e839e086f68e0d47348e3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const DATA_PATH = 'busan_trip_final';

        createApp({
            data() {
                return {
                    activeTab: 'itinerary', selectedDay: 1, calcKrw: null,
                    showModal: false, showBillModal: false, showShopModal: false, showMemberModal: false,
                    isEditing: false, isEditBill: false, isEditShop: false, editIndex: null, memberInput: '',
                    members: ['Bibi'], collapsed: { 'é£Ÿç‰©': false, 'è³¼ç‰©': false, 'å…¶ä»–': false },
                    form: { time: '09:00', place: '', note: '' },
                    billForm: { itemName: '', amount: '', method: 'card', payer: 'Bibi', note: '' },
                    shopForm: { name: '', price: '', category: 'è³¼ç‰©', imgBase64: '' },
                    shoppingList: [], bills: [], itinerary: { 1: [], 2: [], 3: [], 4: [], 5: [] }
                }
            },
            computed: {
                totalSpent() { return (this.bills || []).reduce((sum, b) => sum + (Number(b.amount) || 0), 0); },
                totalCash() { return (this.bills || []).filter(b => b.method === 'cash').reduce((sum, b) => sum + (Number(b.amount) || 0), 0); },
                totalCard() { return (this.bills || []).filter(b => b.method === 'card').reduce((sum, b) => sum + (Number(b.amount) || 0), 0); }
            },
            mounted() {
                db.ref(DATA_PATH).on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        this.itinerary = data.itinerary || { 1: [], 2: [], 3: [], 4: [], 5: [] };
                        this.bills = data.bills || [];
                        this.members = data.members || ['Bibi'];
                        this.shoppingList = (data.shoppingList || []).map((item, index) => ({ ...item, id: index }));
                    }
                });
            },
            methods: {
                sync() { db.ref(DATA_PATH).set({ itinerary: this.itinerary, bills: this.bills, shoppingList: this.shoppingList, members: this.members }); },
                getMemberTotal(name) { return (this.bills || []).filter(b => b.payer === name).reduce((sum, b) => sum + (Number(b.amount) || 0), 0); },
                getCatItems(cat) { return this.shoppingList.filter(i => i.category === cat); },
                
                // è¡Œç¨‹æ–¹æ³• (ä¿®å¾©é‡é»)
                openAddModal() { this.isEditing = false; this.form = { time: '09:00', place: '', note: '' }; this.showModal = true; },
                openEditModal(idx) { 
                    this.isEditing = true; 
                    this.editIndex = idx; 
                    this.form = { ...this.itinerary[this.selectedDay][idx] }; 
                    this.showModal = true; 
                },
                saveForm() {
                    if(!this.itinerary[this.selectedDay]) this.itinerary[this.selectedDay] = [];
                    if(this.isEditing) this.itinerary[this.selectedDay][this.editIndex] = { ...this.form };
                    else this.itinerary[this.selectedDay].push({ ...this.form });
                    this.itinerary[this.selectedDay].sort((a, b) => a.time.localeCompare(b.time));
                    this.sync(); this.showModal = false;
                },
                deleteItem() { if(confirm('ç¢ºå®šåˆªé™¤é€™ç­†è¡Œç¨‹å—ï¼Ÿ')) { this.itinerary[this.selectedDay].splice(this.editIndex, 1); this.sync(); this.showModal = false; } },

                // è¨˜å¸³èˆ‡æ—…ä¼´
                manageMembers() { this.memberInput = this.members.join(', '); this.showMemberModal = true; },
                updateMembers() { this.members = this.memberInput.split(',').map(s => s.trim()).filter(s => s); this.sync(); this.showMemberModal = false; },
                openBillModal() { this.isEditBill = false; this.billForm = { itemName: '', amount: '', method: 'card', payer: this.members[0], note: '' }; this.showBillModal = true; },
                editBill(idx) { this.isEditBill = true; this.editIndex = idx; this.billForm = { ...this.bills[idx] }; this.showBillModal = true; },
                saveBill() { if(!this.billForm.amount) return; if(this.isEditBill) this.bills[this.editIndex] = { ...this.billForm }; else this.bills.unshift({ ...this.billForm }); this.sync(); this.showBillModal = false; },
                deleteBill() { if(confirm('ç¢ºå®šåˆªé™¤é€™ç­†å¸³ç›®å—ï¼Ÿ')) { this.bills.splice(this.editIndex, 1); this.sync(); this.showBillModal = false; } },

                // å¾…è²·èˆ‡è³¼ç‰©
                openShopModal() { this.isEditShop = false; this.shopForm = { name: '', price: '', category: 'è³¼ç‰©', imgBase64: '' }; this.showShopModal = true; },
                editShopItem(id) { 
                    this.isEditShop = true; 
                    const originalIdx = this.shoppingList.findIndex(i => i.id === id);
                    this.editIndex = originalIdx; 
                    this.shopForm = { ...this.shoppingList[originalIdx] }; 
                    this.showShopModal = true; 
                },
                saveShopItem() { 
                    if(!this.shopForm.name) return; 
                    if(this.isEditShop) this.shoppingList[this.editIndex] = { ...this.shopForm }; 
                    else this.shoppingList.push({ ...this.shopForm }); 
                    this.sync(); this.showShopModal = false; 
                },
                deleteShopItem() { if(confirm('ç¢ºå®šåˆªé™¤é€™ç­†å•†å“å—ï¼Ÿ')) { this.shoppingList.splice(this.editIndex, 1); this.sync(); this.showShopModal = false; } },
                handleFileUpload(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (f) => { this.shopForm.imgBase64 = f.target.result; }; reader.readAsDataURL(file); }
            }
        }).mount('#app')
    </script>
</body>
</html>

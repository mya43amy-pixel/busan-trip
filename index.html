<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2026é‡œå±±è¡Œ - Bibi å°ˆå±¬</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --bg-color: #f8fafb;
            --card-bg: #ffffff;
            --primary: #87C4C9; /* é‡œå±±æµ·é¢¨è‰² */
            --primary-dark: #6ba8ad;
            --secondary: #E9F4F5;
            --text-main: #2d3436;
            --text-sub: #636e72;
            --accent-red: #ff7675;
            --accent-orange: #fab1a0;
            --accent-green: #55efc4;
            --shadow: 0 8px 24px rgba(135, 196, 201, 0.12);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Lexend', 'Noto Sans TC', sans-serif;
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            padding-bottom: calc(85px + var(--safe-area-bottom));
            overflow-x: hidden;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 60px 20px 30px;
            text-align: center;
            border-radius: 0 0 40px 40px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
            letter-spacing: 4px;
            font-weight: 400;
            text-transform: uppercase;
        }

        /* æ—¥æœŸé¸æ“‡å™¨ */
        .date-selector {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            gap: 10px;
            margin-top: -25px;
            overflow-x: auto;
        }

        .date-item {
            background: white;
            min-width: 65px;
            height: 85px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .date-item.active {
            background: var(--primary);
            color: white;
            transform: translateY(-5px);
        }

        .date-item span:first-child { font-size: 0.85rem; opacity: 0.8; }
        .date-item span:last-child { font-size: 1.1rem; font-weight: 600; margin-top: 4px; }

        /* ç¸½è¦½å¡ç‰‡å„ªåŒ–ç‰ˆ */
        .summary-card {
            background: var(--primary);
            margin: 15px 20px;
            padding: 25px;
            border-radius: 35px;
            color: white;
            box-shadow: 0 15px 35px rgba(135, 196, 201, 0.4);
            text-align: center;
        }

        .summary-total {
            margin-bottom: 25px;
        }

        .summary-total h3 { font-size: 0.75rem; opacity: 0.8; letter-spacing: 1px; margin: 0; text-transform: uppercase; }
        .summary-total .amount { font-size: 2.2rem; font-weight: 600; margin: 5px 0; display: block; }
        .summary-total .ntd { font-size: 0.9rem; opacity: 0.9; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; display: inline-block; }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-box {
            background: rgba(255,255,255,0.15);
            padding: 15px 10px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .summary-box.highlight {
            background: rgba(255,255,255,0.25);
            border: 1px solid rgba(255,255,255,0.4);
        }

        .summary-box span { font-size: 0.7rem; display: block; margin-bottom: 4px; font-weight: 500; opacity: 0.9; }
        .summary-box strong { font-size: 1.1rem; display: block; }
        .summary-box .sub-txt { font-size: 0.75rem; opacity: 0.8; margin-top: 2px; }

        .summary-split {
            display: flex;
            justify-content: space-around;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 0.8rem;
        }

        .summary-split div span { display: block; opacity: 0.8; font-size: 0.7rem; margin-bottom: 3px; }

        /* å…§å®¹å€å¡Š */
        .content-section { display: none; padding: 0 20px; animation: fadeIn 0.4s ease; }
        .content-section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* åˆ—è¡¨æ¨£å¼ */
        .item-card {
            background: white;
            border-radius: 22px;
            padding: 18px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }

        .item-icon {
            width: 45px;
            height: 45px;
            border-radius: 14px;
            background: var(--secondary);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-right: 15px;
        }

        .item-info { flex: 1; }
        .item-info .title { font-weight: 600; font-size: 1.05rem; display: block; color: var(--text-main); }
        .item-info .meta { font-size: 0.75rem; color: var(--text-sub); margin-top: 3px; }
        .item-info .note { font-size: 0.75rem; color: var(--primary); font-style: italic; margin-top: 2px; display: block; }

        .item-amount { text-align: right; }
        .item-amount .krw { 
            font-weight: 600; 
            font-size: 1.05rem; 
            display: flex; 
            align-items: center; 
            justify-content: flex-end;
            gap: 4px;
        }
        .item-amount .ntd { font-size: 0.75rem; color: #b2bec3; display: block; margin-top: 2px; }

        .amount-pos { color: #f39c12; }
        .amount-neg { color: var(--text-main); }

        /* è¡Œå‹•å°è¦½åˆ— */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            height: calc(75px + var(--safe-area-bottom));
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: var(--safe-area-bottom);
            box-shadow: 0 -5px 25px rgba(0,0,0,0.05);
            z-index: 1000;
            border-radius: 30px 30px 0 0;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #b2bec3;
            text-decoration: none;
            transition: all 0.3s;
            width: 25%;
        }

        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.4rem; margin-bottom: 5px; }
        .nav-item span { font-size: 0.7rem; font-weight: 500; letter-spacing: 0.5px; }

        /* æ‡¸æµ®æŒ‰éˆ• */
        .fab {
            position: fixed;
            bottom: calc(100px + var(--safe-area-bottom));
            right: 25px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 10px 25px rgba(135, 196, 201, 0.5);
            z-index: 999;
            border: none;
            transition: transform 0.2s;
        }

        .fab:active { transform: scale(0.9); }

        /* Modal å„ªåŒ– */
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: flex-end;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            width: 100%;
            border-radius: 40px 40px 0 0;
            padding: 30px 25px calc(30px + var(--safe-area-bottom));
            animation: slideUp 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .modal-header h2 { margin: 0; font-size: 1.3rem; }
        .close-btn { font-size: 1.5rem; color: #b2bec3; cursor: pointer; }

        /* è¡¨å–®å…ƒç´  */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 0.85rem; color: var(--text-sub); margin-bottom: 8px; margin-left: 5px; }
        .form-input {
            width: 100%;
            padding: 15px 20px;
            border-radius: 18px;
            border: 1px solid #f1f3f5;
            background: #f8fafb;
            font-size: 1.1rem;
            outline: none;
            transition: all 0.3s;
        }
        .form-input:focus { border-color: var(--primary); background: white; }

        .type-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            background: #f1f3f5;
            padding: 5px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .type-btn {
            padding: 12px;
            text-align: center;
            border-radius: 12px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.3s;
        }
        .type-btn.active { background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.05); color: var(--primary); font-weight: 600; }
        .type-btn.active.expense { color: var(--accent-red); }

        .btn-submit {
            width: 100%;
            padding: 18px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 10px;
        }

        /* è³¼ç‰©æ¸…å–® & Memo */
        .shop-section { margin-bottom: 30px; }
        .shop-title { 
            font-size: 0.95rem; 
            font-weight: 600; 
            margin-bottom: 15px; 
            display: flex; 
            align-items: center; 
            gap: 10px;
            color: var(--text-sub);
        }

        .shop-card {
            background: white;
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .shop-img { width: 60px; height: 60px; border-radius: 15px; object-fit: cover; margin-right: 15px; background: #eee; }
        .shop-info { flex: 1; }
        .shop-info .name { font-weight: 600; display: block; }
        .shop-info .price { font-size: 0.85rem; color: var(--primary); margin-top: 3px; font-weight: 500; }
        .shop-info .store { font-size: 0.7rem; color: #b2bec3; }

        .check-circle { 
            width: 26px; height: 26px; border-radius: 50%; 
            border: 2px solid #dfe6e9; display: flex; align-items: center; 
            justify-content: center; cursor: pointer; color: white;
        }
        .check-circle.checked { background: var(--accent-green); border-color: var(--accent-green); }

        .memo-card {
            background: #fff;
            padding: 20px;
            border-radius: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 15px;
            position: relative;
        }
        .memo-text { font-size: 0.95rem; line-height: 1.6; white-space: pre-wrap; }
        .memo-time { font-size: 0.7rem; color: #b2bec3; margin-top: 12px; display: block; }

        /* è¡Œç¨‹æ’åºæ‰‹æŠŠ */
        .drag-handle { color: #dfe6e9; margin-right: 15px; cursor: grab; padding: 10px 5px; }

        /* é€€ç¨…èˆ‡æ”¶å…¥å°ˆç”¨é…è‰² */
        .amount-income { color: #f39c12 !important; }

    </style>
</head>
<body>

    <header>
        <h1 id="main-title">2026 BUSAN</h1>
    </header>

    <div class="date-selector" id="date-list">
        </div>

    <div id="section-wallet" class="content-section active">
        <div class="summary-card">
            <div class="summary-total">
                <h3>Total Spent / ç¸½èŠ±è²»</h3>
                <span class="amount" id="sum-total-krw">â‚© 0</span>
                <span class="ntd" id="sum-total-ntd">â‰ˆ NT$ 0</span>
            </div>
            
            <div class="summary-grid">
                <div class="summary-box highlight">
                    <span>å‰©é¤˜ç¾é‡‘ (éŒ¢åŒ…è£¡)</span>
                    <strong id="sum-cash-left">â‚© 0</strong>
                    <div class="sub-txt" id="sum-cash-left-ntd">â‰ˆ NT$ 0</div>
                </div>
                <div class="summary-box">
                    <span>åˆ·å¡ç´¯è¨ˆ (å«é€€ç¨…)</span>
                    <strong id="sum-card-spent">â‚© 0</strong>
                    <div class="sub-txt" id="sum-card-spent-ntd">â‰ˆ NT$ 0</div>
                </div>
            </div>

            <div class="summary-split">
                <div onclick="filterOwner('å…±åŒ')"><span>å…±åŒ</span><strong id="sum-common">â‚© 0</strong></div>
                <div onclick="filterOwner('å¤§æ¯”')"><span>å¤§æ¯”</span><strong id="sum-bibi">â‚© 0</strong></div>
                <div onclick="filterOwner('å°æ¯”')"><span>å°æ¯”</span><strong id="sum-mya">â‚© 0</strong></div>
            </div>
        </div>

        <div style="padding: 0 5px 15px; display: flex; justify-content: flex-end;">
            <span style="font-size: 0.75rem; color: var(--text-sub);"><i class="fas fa-users"></i> æ—…ä¼´æˆå“¡</span>
        </div>

        <div id="wallet-list">
            </div>
    </div>

    <div id="section-plan" class="content-section">
        <div id="plan-list">
            </div>
    </div>

    <div id="section-shop" class="content-section">
        <div id="shop-container">
            </div>
        <button class="btn-submit" style="background: white; color: var(--primary); border: 2px dashed var(--primary); margin-bottom: 20px;" onclick="openShopModal()">+ æ–°å¢å¾…è²·</button>
        
        <div class="shop-title" style="margin-top: 30px;"><i class="fas fa-sticky-note"></i> MEMO / LINKS</div>
        <div id="memo-list"></div>
        <button class="btn-submit" style="background: #e9f4f5; color: var(--primary-dark);" onclick="openMemoModal()">+ æ–°å¢ MEMO</button>
    </div>

    <nav class="nav-bar">
        <a href="#" class="nav-item" onclick="showSection('plan')">
            <i class="far fa-calendar-alt"></i><span>PLAN</span>
        </a>
        <a href="#" class="nav-item active" onclick="showSection('wallet')">
            <i class="fas fa-wallet"></i><span>WALLET</span>
        </a>
        <a href="#" class="nav-item" onclick="showSection('shop')">
            <i class="fas fa-shopping-bag"></i><span>SHOP</span>
        </a>
    </nav>

    <button class="fab" id="fab-add" onclick="openAddModal()"><i class="fas fa-plus"></i></button>

    <div class="modal" id="modal-add">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">è¨˜å¸³ ğŸ’°</h2>
                <span class="close-btn" onclick="closeModal('modal-add')">&times;</span>
            </div>
            
            <div class="type-toggle" id="main-type-toggle">
                <div class="type-btn active" id="btn-tab-expense" onclick="switchMainTab('expense')">æ”¯å‡º</div>
                <div class="type-btn" id="btn-tab-income" onclick="switchMainTab('income')">æ”¶å…¥/æ›éŒ¢</div>
            </div>

            <div class="form-group">
                <label>é‡‘é¡ (KRW)</label>
                <input type="number" class="form-input" id="inp-amount" placeholder="0" inputmode="numeric">
            </div>

            <div class="form-group">
                <label>é …ç›®</label>
                <input type="text" class="form-input" id="inp-title" placeholder="ä¾‹å¦‚ï¼šé­šæ¿ã€é€€ç¨…ã€æ›éŒ¢">
            </div>

            <div class="summary-grid">
                <div class="form-group">
                    <label>æ”¯ä»˜æ–¹å¼</label>
                    <select class="form-input" id="inp-pay-method">
                        <option value="ç¾é‡‘">ç¾é‡‘</option>
                        <option value="åˆ·å¡">åˆ·å¡</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>åˆ†é¡</label>
                    <select class="form-input" id="inp-category">
                        <option value="é£Ÿç‰©">é£Ÿç‰©</option>
                        <option value="äº¤é€š">äº¤é€š</option>
                        <option value="è³¼ç‰©">è³¼ç‰©</option>
                        <option value="æ™¯é»">æ™¯é»</option>
                        <option value="æ›éŒ¢">æ›éŒ¢/æ”¶å…¥</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>å°è±¡</label>
                <select class="form-input" id="inp-owner">
                    <option value="å…±åŒ">å…±åŒ</option>
                    <option value="å¤§æ¯”">å¤§æ¯”</option>
                    <option value="å°æ¯”">å°æ¯”</option>
                </select>
            </div>

            <div class="form-group">
                <label>å‚™è¨»</label>
                <input type="text" class="form-input" id="inp-note" placeholder="å¯ä¸å¡«">
            </div>

            <button class="btn-submit" onclick="saveData()">å„²å­˜ç´€éŒ„</button>
            <button class="btn-submit" id="btn-delete" style="background: #fab1a0; margin-top: 10px; display:none;" onclick="deleteData()">åˆªé™¤é€™ç­†</button>
        </div>
    </div>

    <div class="modal" id="modal-shop">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æƒ³è¦è²·çš„æ±è¥¿ ğŸ›ï¸</h2>
                <span class="close-btn" onclick="closeModal('modal-shop')">&times;</span>
            </div>
            <div class="form-group"><label>åç¨±</label><input type="text" class="form-input" id="shop-name"></div>
            <div class="form-group"><label>é ä¼°åƒ¹æ ¼/å‚™è¨»</label><input type="text" class="form-input" id="shop-price"></div>
            <div class="form-group">
                <label>åˆ†é¡</label>
                <select class="form-input" id="shop-cat">
                    <option value="ç¾å¦">ç¾å¦</option>
                    <option value="é£Ÿç‰©">é£Ÿç‰©</option>
                    <option value="è³¼ç‰©">è³¼ç‰©</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>
            <div class="form-group"><label>åœ–ç‰‡ç¶²å€ (å¯ä¸å¡«)</label><input type="text" class="form-input" id="shop-img"></div>
            <button class="btn-submit" onclick="saveShop()">åŠ å…¥æ¸…å–®</button>
        </div>
    </div>

    <div class="modal" id="modal-memo">
        <div class="modal-content">
            <div class="modal-header">
                <h2>è¨˜äº‹æœ¬ / é€£çµ ğŸ“</h2>
                <span class="close-btn" onclick="closeModal('modal-memo')">&times;</span>
            </div>
            <div class="form-group">
                <textarea class="form-input" id="memo-text" rows="6" placeholder="è²¼ä¸Šç¶²å€æˆ–æ˜¯æƒ³è¨˜ä¸‹ä¾†çš„äº‹æƒ…..."></textarea>
            </div>
            <button class="btn-submit" onclick="saveMemo()">å„²å­˜ MEMO</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            databaseURL: "https://busan-2026-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const DATA_PATH = "busan_trip_v7"; 

        // ç‹€æ…‹ç®¡ç†
        let state = {
            currentDate: '17',
            currentSection: 'wallet',
            dbData: {
                wallet: {},
                plan: {},
                shop: {},
                memo: {}
            },
            editingId: null,
            isIncome: false,
            rate: 0.024 // é è¨­åŒ¯ç‡
        };

        const dates = [
            { d: '17', w: 'äºŒ' }, { d: '18', w: 'ä¸‰' }, { d: '19', w: 'å››' },
            { d: '20', w: 'äº”' }, { d: '21', w: 'å…­' }
        ];

        // åˆå§‹åŒ–
        window.onload = () => {
            renderDateSelector();
            initRealtimeSync();
        };

        function initRealtimeSync() {
            onValue(ref(db, DATA_PATH), (snapshot) => {
                const val = snapshot.val();
                if (val) {
                    state.dbData = {
                        wallet: val.wallet || {},
                        plan: val.plan || {},
                        shop: val.shop || {},
                        memo: val.memo || {}
                    };
                    refreshUI();
                }
            });
        }

        function renderDateSelector() {
            const container = document.getElementById('date-list');
            container.innerHTML = dates.map(date => `
                <div class="date-item ${state.currentDate === date.d ? 'active' : ''}" onclick="selectDate('${date.d}')">
                    <span>${date.w}</span>
                    <span>${date.d}</span>
                </div>
            `).join('');
        }

        window.selectDate = (d) => {
            state.currentDate = d;
            renderDateSelector();
            refreshUI();
        };

        window.showSection = (section) => {
            state.currentSection = section;
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`section-${section}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // æ ¹æ“šåˆ†é é¡¯ç¤ºå°æ‡‰æŒ‰éˆ•
            const fab = document.getElementById('fab-add');
            if (section === 'shop') fab.style.display = 'none';
            else fab.style.display = 'flex';
        };

        function refreshUI() {
            if (state.currentSection === 'wallet') renderWallet();
            else if (state.currentSection === 'plan') renderPlan();
            else if (state.currentSection === 'shop') {
                renderShop();
                renderMemo();
            }
        }

        // --- å¸³å‹™é‚è¼¯ ---
        function renderWallet() {
            const list = document.getElementById('wallet-list');
            const items = Object.entries(state.dbData.wallet)
                .map(([id, data]) => ({ id, ...data }))
                .filter(item => item.date === state.currentDate)
                .sort((a, b) => b.timestamp - a.timestamp);

            list.innerHTML = items.map(item => `
                <div class="item-card" onclick="openEditModal('${item.id}', 'wallet')">
                    <div class="item-icon">
                        ${item.type === 'income' ? '<i class="fas fa-hand-holding-usd" style="color:#f39c12"></i>' : getCatIcon(item.category)}
                    </div>
                    <div class="item-info">
                        <span class="title">${item.title}</span>
                        <div class="meta">
                            <span>${item.owner} Â· ${item.category}</span>
                            <span style="margin-left:8px"><i class="${item.payMethod === 'ç¾é‡‘' ? 'fas fa-money-bill-wave' : 'far fa-credit-card'}"></i></span>
                        </div>
                        ${item.note ? `<span class="note">${item.note}</span>` : ''}
                    </div>
                    <div class="item-amount">
                        <span class="krw ${item.type === 'income' ? 'amount-income' : 'amount-neg'}">
                            ${item.type === 'income' ? '+' : '-'} â‚© ${Number(item.amount).toLocaleString()}
                        </span>
                        <span class="ntd">NT$ ${Math.round(item.amount * state.rate).toLocaleString()}</span>
                    </div>
                </div>
            `).join('');

            calculateSummary();
        }

        function calculateSummary() {
            const allItems = Object.values(state.dbData.wallet);
            let totalKRW = 0;
            let cashLeft = 0;
            let cardSpent = 0;
            let common = 0, bibi = 0, mya = 0;

            allItems.forEach(item => {
                const amt = Number(item.amount);
                
                if (item.type === 'income') {
                    // æ”¶å…¥é‚è¼¯
                    if (item.payMethod === 'ç¾é‡‘') {
                        cashLeft += amt; // å¢åŠ ç¾éˆ”é¤˜é¡
                    } else {
                        cardSpent -= amt; // æ‰£æŠµåˆ·å¡å¸³å–® (é€€ç¨…)
                    }
                } else {
                    // æ”¯å‡ºé‚è¼¯
                    totalKRW += amt;
                    if (item.payMethod === 'ç¾é‡‘') {
                        cashLeft -= amt;
                    } else {
                        cardSpent += amt;
                    }

                    if (item.owner === 'å…±åŒ') common += amt;
                    else if (item.owner === 'å¤§æ¯”') bibi += amt;
                    else if (item.owner === 'å°æ¯”') mya += amt;
                }
            });

            document.getElementById('sum-total-krw').innerText = `â‚© ${totalKRW.toLocaleString()}`;
            document.getElementById('sum-total-ntd').innerText = `â‰ˆ NT$ ${Math.round(totalKRW * state.rate).toLocaleString()}`;
            
            document.getElementById('sum-cash-left').innerText = `â‚© ${cashLeft.toLocaleString()}`;
            document.getElementById('sum-cash-left-ntd').innerText = `â‰ˆ NT$ ${Math.round(cashLeft * state.rate).toLocaleString()}`;
            
            document.getElementById('sum-card-spent').innerText = `â‚© ${cardSpent.toLocaleString()}`;
            document.getElementById('sum-card-spent-ntd').innerText = `â‰ˆ NT$ ${Math.round(cardSpent * state.rate).toLocaleString()}`;

            document.getElementById('sum-common').innerText = `â‚© ${common.toLocaleString()}`;
            document.getElementById('sum-bibi').innerText = `â‚© ${bibi.toLocaleString()}`;
            document.getElementById('sum-mya').innerText = `â‚© ${mya.toLocaleString()}`;
        }

        // --- è¡Œç¨‹é‚è¼¯ ---
        function renderPlan() {
            const list = document.getElementById('plan-list');
            const items = Object.entries(state.dbData.plan)
                .map(([id, data]) => ({ id, ...data }))
                .filter(item => item.date === state.currentDate)
                .sort((a, b) => a.order - b.order);

            list.innerHTML = items.map(item => `
                <div class="item-card" data-id="${item.id}" onclick="openEditModal('${item.id}', 'plan')">
                    <div class="drag-handle"><i class="fas fa-grip-lines"></i></div>
                    <div class="item-icon">${getCatIcon(item.category)}</div>
                    <div class="item-info">
                        <span class="title">${item.title}</span>
                        <div class="meta">${item.category}</div>
                        ${item.note ? `<span class="note">${item.note}</span>` : ''}
                    </div>
                </div>
            `).join('');

            // å•Ÿç”¨æ‹–æ›³æ’åº
            new Sortable(list, {
                handle: '.drag-handle',
                animation: 150,
                onEnd: function() {
                    const newOrder = Array.from(list.children).map((el, index) => {
                        const id = el.getAttribute('data-id');
                        update(ref(db, `${DATA_PATH}/plan/${id}`), { order: index });
                    });
                }
            });
        }

        // --- è³¼ç‰©èˆ‡å‚™å¿˜ ---
        function renderShop() {
            const container = document.getElementById('shop-container');
            const items = Object.entries(state.dbData.shop).map(([id, d]) => ({ id, ...d }));
            const cats = ['ç¾å¦', 'é£Ÿç‰©', 'è³¼ç‰©', 'å…¶ä»–'];

            container.innerHTML = cats.map(cat => {
                const catItems = items.filter(i => i.category === cat);
                if (catItems.length === 0 && cat !== 'å…¶ä»–') return '';
                return `
                    <div class="shop-section">
                        <div class="shop-title">${cat} (${catItems.length}) <i class="fas fa-chevron-down" style="font-size:0.7rem"></i></div>
                        ${catItems.map(item => `
                            <div class="shop-card">
                                ${item.img ? `<img src="${item.img}" class="shop-img">` : '<div class="shop-img" style="display:flex;align-items:center;justify-content:center;color:#ccc"><i class="fas fa-image"></i></div>'}
                                <div class="shop-info">
                                    <span class="name">${item.name}</span>
                                    <span class="price">${item.price || 'å°šæœªæ¨™åƒ¹'}</span>
                                </div>
                                <div class="check-circle ${item.checked ? 'checked' : ''}" onclick="toggleShop('${item.id}', ${item.checked})">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div style="margin-left:15px; color:#dfe6e9" onclick="deleteShop('${item.id}')"><i class="fas fa-trash-alt"></i></div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');
        }

        function renderMemo() {
            const list = document.getElementById('memo-list');
            const items = Object.entries(state.dbData.memo)
                .map(([id, data]) => ({ id, ...data }))
                .sort((a, b) => b.timestamp - a.timestamp);

            list.innerHTML = items.map(item => `
                <div class="memo-card">
                    <div style="position:absolute; right:15px; top:15px; color:#dfe6e9" onclick="deleteMemo('${item.id}')">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="memo-text">${linkify(item.text)}</div>
                    <span class="memo-time">${new Date(item.timestamp).toLocaleString()}</span>
                </div>
            `).join('');
        }

        // --- åŠŸèƒ½èˆ‡å½ˆçª— ---
        window.switchMainTab = (tab) => {
            state.isIncome = (tab === 'income');
            document.getElementById('btn-tab-expense').classList.toggle('active', !state.isIncome);
            document.getElementById('btn-tab-income').classList.toggle('active', state.isIncome);
            
            // é è¨­åˆ‡æ›
            if (state.isIncome) {
                document.getElementById('inp-category').value = 'æ›éŒ¢';
                document.getElementById('inp-pay-method').value = 'ç¾é‡‘';
            } else {
                document.getElementById('inp-category').value = 'é£Ÿç‰©';
            }
        };

        window.openAddModal = () => {
            state.editingId = null;
            document.getElementById('modal-title').innerText = state.currentSection === 'wallet' ? 'è¨˜å¸³ ğŸ’°' : 'æ–°å¢è¡Œç¨‹ ğŸ“';
            document.getElementById('btn-delete').style.display = 'none';
            document.getElementById('main-type-toggle').style.display = state.currentSection === 'wallet' ? 'grid' : 'none';
            
            // é‡ç½®æ¬„ä½
            document.getElementById('inp-amount').value = '';
            document.getElementById('inp-title').value = '';
            document.getElementById('inp-note').value = '';
            document.getElementById('modal-add').style.display = 'flex';
        };

        window.openEditModal = (id, type) => {
            state.editingId = id;
            const data = state.dbData[type][id];
            document.getElementById('modal-title').innerText = 'ç·¨è¼¯ç´€éŒ„';
            document.getElementById('btn-delete').style.display = 'block';
            
            document.getElementById('inp-amount').value = data.amount || '';
            document.getElementById('inp-title').value = data.title;
            document.getElementById('inp-category').value = data.category;
            document.getElementById('inp-owner').value = data.owner || 'å…±åŒ';
            document.getElementById('inp-pay-method').value = data.payMethod || 'ç¾é‡‘';
            document.getElementById('inp-note').value = data.note || '';

            if (type === 'wallet') {
                switchMainTab(data.type || 'expense');
                document.getElementById('main-type-toggle').style.display = 'grid';
            } else {
                document.getElementById('main-type-toggle').style.display = 'none';
            }

            document.getElementById('modal-add').style.display = 'flex';
        };

        window.saveData = () => {
            const amount = document.getElementById('inp-amount').value;
            const title = document.getElementById('inp-title').value;
            if (!title) return alert('è«‹å¡«å¯«é …ç›®åç¨±');

            const payload = {
                title,
                amount: amount || 0,
                category: document.getElementById('inp-category').value,
                owner: document.getElementById('inp-owner').value,
                payMethod: document.getElementById('inp-pay-method').value,
                note: document.getElementById('inp-note').value,
                date: state.currentDate,
                type: state.isIncome ? 'income' : 'expense',
                timestamp: Date.now()
            };

            const type = state.currentSection; // wallet or plan
            if (state.editingId) {
                update(ref(db, `${DATA_PATH}/${type}/${state.editingId}`), payload);
            } else {
                if (type === 'plan') payload.order = Object.keys(state.dbData.plan).length;
                push(ref(db, `${DATA_PATH}/${type}`), payload);
            }
            closeModal('modal-add');
        };

        window.deleteData = () => {
            if (confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) {
                remove(ref(db, `${DATA_PATH}/${state.currentSection}/${state.editingId}`));
                closeModal('modal-add');
            }
        };

        // --- è³¼ç‰©/MEMO å„²å­˜ ---
        window.openShopModal = () => document.getElementById('modal-shop').style.display = 'flex';
        window.saveShop = () => {
            const name = document.getElementById('shop-name').value;
            if (!name) return;
            push(ref(db, `${DATA_PATH}/shop`), {
                name,
                price: document.getElementById('shop-price').value,
                category: document.getElementById('shop-cat').value,
                img: document.getElementById('shop-img').value,
                checked: false
            });
            closeModal('modal-shop');
        };
        window.toggleShop = (id, cur) => update(ref(db, `${DATA_PATH}/shop/${id}`), { checked: !cur });
        window.deleteShop = (id) => confirm('åˆªé™¤æ­¤é …ï¼Ÿ') && remove(ref(db, `${DATA_PATH}/shop/${id}`));

        window.openMemoModal = () => document.getElementById('modal-memo').style.display = 'flex';
        window.saveMemo = () => {
            const text = document.getElementById('memo-text').value;
            if (!text) return;
            push(ref(db, `${DATA_PATH}/memo`), { text, timestamp: Date.now() });
            closeModal('modal-memo');
            document.getElementById('memo-text').value = '';
        };
        window.deleteMemo = (id) => confirm('åˆªé™¤é€™å‰‡å‚™å¿˜ï¼Ÿ') && remove(ref(db, `${DATA_PATH}/memo/${id}`));

        // è¼”åŠ©å‡½å¼
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        
        function getCatIcon(cat) {
            const map = {
                'é£Ÿç‰©': '<i class="fas fa-utensils"></i>',
                'äº¤é€š': '<i class="fas fa-bus"></i>',
                'è³¼ç‰©': '<i class="fas fa-shopping-bag"></i>',
                'æ™¯é»': '<i class="fas fa-camera"></i>',
                'æ›éŒ¢': '<i class="fas fa-coins"></i>',
                'å…¶ä»–': '<i class="fas fa-ellipsis-h"></i>'
            };
            return map[cat] || map['å…¶ä»–'];
        }

        function linkify(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, (url) => `<a href="${url}" target="_blank" style="color:var(--primary); word-break:break-all;">${url}</a>`);
        }
    </script>
</body>
</html>
